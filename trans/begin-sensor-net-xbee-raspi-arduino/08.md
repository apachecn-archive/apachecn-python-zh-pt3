# 8.将您的 Raspberry Pi 变成数据库服务器

既然您已经知道了什么是传感器网络，甚至如何使用 Arduino 和 Raspberry Pi 构建传感器节点，那么是时候用您的 Raspberry Pi 做一些真正酷的事情了。上一章讨论了存储传感器数据的各种方法。最可靠和最通用的方法之一是将您的传感器数据存储在数据库中。本章探索了如何使用 Raspberry Pi 作为数据库服务器。

虽然这一直是从旧版本的 2B 板开始的树莓 Pi 的一个选项，但现在树莓 Pi 4B 板出来了，它甚至更是一个选项。他们有足够的处理能力和更多的内存来处理繁重的数据库工作。酷！

您从简单介绍 MySQL 开始，然后开始在 Raspberry Pi 上运行 MySQL。如果你有安装和使用 MySQL 的经验，你可以跳到“构建一个 Raspberry Pi MySQL 服务器”一节。

## 什么是 MySQL？

MySQL 是世界上最受欢迎的开源数据库系统，原因有很多。首先，它是开源的，这意味着任何人都可以免费使用它来完成各种各样的任务。 <sup>[2](#Fn2)</sup> 最棒的是，MySQL 被包含在许多平台仓库中，使其易于获取和安装。如果你的平台在资源库中没有包含 MySQL(比如 aptitude)，可以从 MySQL 网站( [`http://dev.mysql.com`](http://dev.mysql.com) )下载。

甲骨文公司拥有 MySQL。Oracle 通过收购 Sun Microsystems 获得了 MySQL，Sun Microsystems 从其原始所有者 MySQL AB 获得了 MySQL。尽管担心会出现相反的情况，但 Oracle 通过继续投资于新功能的演进和开发以及忠实地维护其开源遗产，表现出了对 MySQL 的出色管理。尽管 Oracle 也提供 MySQL 的商业许可——就像它以前的所有者过去做的那样——MySQL 仍然是开源的，每个人都可以使用。

What is Open Source? Is it Really Free?

开源软件是从对公司财产心态的有意识抵制中成长起来的。在为麻省理工工作时，自由软件运动之父理查德·斯托尔曼抵制了软件私有(封闭)的趋势，离开了麻省理工，创办了 GNU (GNU 的非 Unix)项目和自由软件基金会(FSF)。

斯托曼的目标是重建一个合作的开发者社区。然而，他有先见之明，意识到这个系统需要版权许可来保证某些自由。(有些人把斯托曼对版权的理解称为“左版权”，因为它保障了自由，而不是限制了自由。)为了解决这个问题，斯托曼创建了 GNU 公共许可证(GPL)。GPL 是一个巧妙的法律许可作品，它允许代码不受限制地被复制和修改，规定衍生作品(修改后的副本)必须在与原始版本相同的许可下发布，没有任何附加限制。

自由软件运动有一个问题。自由一词旨在保证使用、修改和发布的自由；这并不意味着“没有成本”或“免费到一个好的家。”为了消除这种误解，开放源码倡议(OSI)成立了，后来采用并推广了“开放源码”一词来描述 GPL 许可证所保证的自由。有关开源软件的更多信息，请访问 [`www.opensource.org`](http://www.opensource.org) 。

MySQL 在你的系统上作为后台进程运行(或者作为前台进程运行，如果你从命令行 <sup>[3](#Fn3)</sup> )。像大多数数据库系统一样，MySQL 支持结构化查询语言(SQL)。您可以使用 SQL 创建数据库和对象(使用数据定义语言[DDL])，写入或更改数据(使用数据操作语言[DML])，以及执行各种命令来管理服务器。

要发出这些命令，必须首先连接到数据库服务器。MySQL 提供了一个客户端应用程序，使您能够连接到服务器并在其上运行命令。该应用程序被命名为 MySQL Shell ( `mysqlsh`)，与旧客户端相比有许多改进，包括更好的界面以及 SQL、Python 和 JavaScript 模式。如果你过去用过 MySQL，你可能会对老一点的 MySQL 客户端(`mysql`)比较熟悉，也可以用，但是 MySQL Shell 就好用多了。请参阅 MySQL Shell 的在线参考手册( [`https://dev.mysql.com/doc/mysql-shell/8.0/en/`](https://dev.mysql.com/doc/mysql-shell/8.0/en/) )以了解更多关于如何使用它的信息，但是那些使用过旧客户端的人或者跟随教程的人会很快上手。

Tip

在 Raspberry Pi 上工作时最好使用旧的`mysql`客户端，因为它需要的编译和安装步骤更少，但是您可以在 Raspberry Pi 上构建和安装 MySQL Shell。

如果您还没有安装 MySQL Shell，请访问 [`https://dev.mysql.com/downloads/shell/`](https://dev.mysql.com/downloads/shell/) 并下载，然后安装在您的系统上。对于 macOS 和 Linux，请遵循您用于任何其他软件的特定于平台的安装过程。对于 Windows，您可以下载单独的 MySQL Shell 安装(`.msi`)或者下载 Windows Installer，其中包含所有 MySQL 应用程序、工具和驱动程序。在这种情况下，您只需在安装开始时选择想要的组件。

当然，你还需要访问运行在某个地方的 MySQL 服务器。好消息是你可以在你的电脑上安装它！只需从 [`https://dev.mysql.com/downloads/mysql/`](https://dev.mysql.com/downloads/mysql/) 网站(社区版)下载正确的安装程序，安装在你的系统上即可。它非常容易安装，但如果你想要一步一步的指导，请参见在线参考手册获得帮助( [`https://dev.mysql.com/doc/refman/8.0/en/`](https://dev.mysql.com/doc/refman/8.0/en/) )。

一旦 MySQL Shell 安装到您的系统上，您就可以启动它，如清单 [8-1](#PC1) 所示，该清单显示了前面讨论的每种类型命令的示例。请注意，这些命令在旧客户端中的工作方式是相同的。

```py
$ mysqlsh --uri root@localhost:33060
Please provide the password for 'root@localhost:33060':
Save password for 'root@localhost:33060'? [Y]es/[N]o/Ne[v]er (default No): y
MySQL Shell 8.0.18

Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
Creating a session to 'root@localhost:33060'
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 8 (X protocol)
Server version: 8.0.18 MySQL Community Server – GPL

> CREATE DATABASE testme;
Query OK, 1 row affected (0.0012 sec)

> CREATE TABLE testme.table1 (sensor_node char(30), sensor_value int, sensor_event timestamp);
Query OK, 0 rows affected (0.0059 sec)

> INSERT INTO testme.table1 VALUES ('living room', 23, NULL);
Query OK, 1 row affected (0.0051 sec)

> SELECT ∗ FROM testme.table1;
+-------------+--------------+--------------+
| sensor_node | sensor_value | sensor_event |
+-------------+--------------+--------------+
| living room |           23 | NULL         |
+-------------+--------------+--------------+
1 row in set (0.0003 sec)

> SET @@global.server_id = 111;
Query OK, 0 rows affected (0.0002 sec)

> \q
Bye!

Listing 8-1Commands Using the MySQL Shell

```

如果您还没有使用过 MySQL Shell，请看看我是如何启动这个 Shell 的。注意，我以不同的格式输入了用户凭证，这非常直观，比单独的选项要简单一些。还要注意，shell 允许我保存密码，以便以后更快地登录。很好！

在本例中，您看到 DML 以`CREATE DATABASE`和`CREATE TABLE`语句的形式出现，DDL 以`INSERT`和`SELECT`语句的形式出现，还有一个简单的管理命令来设置全局服务器变量。接下来，创建一个数据库和一个表来存储数据，在表中添加一行，最后检索表中的数据。

MySQL 中有很多可用的命令。幸运的是，你只需要掌握几个比较常见的。以下是您最常使用的命令。`<>`中包含的部分表示用户提供的命令组件，而`[...]`表示需要额外的选项:

Tip

必须用分号(`;`或`\G`结束每个命令。

*   `CREATE DATABASE <database_name>`:创建数据库

*   `USE <database>`:设置默认数据库

*   `CREATE TABLE <table_name> [...]`:创建一个表格或结构来存储数据

*   `INSERT INTO <table_name> [...]`:向表格中添加数据

*   `UPDATE [...]`:更改特定行的一个或多个值

*   `DELETE FROM <table_name> [...` ]:从表格中删除数据

*   `SELECT [...]`:从表格中检索数据(行)

虽然这个列表只是一个简短的介绍，并不像一个完整的语法指南，但有一个很好的在线参考手册，它非常详细地解释了每个命令(以及更多)。当你对 MySQL 有任何疑问时，你应该参考在线参考手册。你可以在 [`https://dev.mysql.com/doc/refman/8.0/en/`](https://dev.mysql.com/doc/refman/8.0/en/) 找到它。

如果您认为 MySQL 不仅仅是几个简单的命令，那么您绝对是正确的。尽管 MySQL 易于使用且启动时间快，但它是一个成熟的关系数据库管理系统(RDBMS)。比你在这里看到的要多得多。有关 MySQL 的更多信息，包括所有高级特性，请参见参考手册。

MYSQL—What Does it Mean?

MySQL 这个名字是一个专有名称和一个缩写的组合。SQL 是结构化查询语言。“我的部分”不是所有格形式——它是一个名称。在这种情况下，My 是创始人的一个女儿的名字。至于发音，MySQL 专家发音为“My-S-Q-L”而不是“my sequel”事实上，一个精明的 MySQL 用户的标志在于他们对产品的正确发音。

## MySQL 入门

既然您已经知道了 MySQL 是什么以及它是如何使用的，那么在开始构建您的第一个数据库服务器之前，您需要对 RDBMSs 和 MySQL 有更多的了解。本节讨论 MySQL 如何存储数据(以及存储在哪里)，如何与其他系统通信，以及管理新 MySQL 服务器所需的一些基本管理任务。

Note

我将这些信息作为 MySQL 的教程或入门介绍。在后面的小节中，您将在 Raspberry Pi 上安装 MySQL。

但是首先，让我们回顾一下什么是关系数据库系统以及它为什么重要。

### 什么是关系数据库管理系统？

RDBMS 是一种基于数据关系模型的数据存储和检索服务，由 E. F. Codd 于 1970 年提出。这些系统是结构化数据的标准存储机制。大量的研究致力于改进 Codd 提出的基本模型，正如 C. J. Date 在*数据库关系模型:回顾和分析*中所讨论的。 <sup>[4](#Fn4)</sup> 这种理论和实践的演变最好地记录在第三个宣言中。 <sup>[5](#Fn5)</sup>

关系模型是存储库(数据库)的直观概念，可以通过使用一种称为查询语言的机制来检索、更新和插入数据，从而方便地查询存储库。关系模型已经被许多厂商实现，因为它具有完善的系统理论、坚实的数学基础和简单的结构。最常用的查询机制是 SQL，它类似于自然语言。虽然关系模型中不包括 SQL，但它提供了关系模型在 RDBMSs 中的实际应用的一个组成部分。

数据被表示为关于特定事件或实体的相关信息(属性或列)。属性值集以元组的形式形成(有时称为记录或行)。元组存储在具有相同属性集的表中。然后，表可以通过键、属性和元组的约束与其他表相关。

表可以有称为索引的列的特殊映射，允许您以特定的顺序读取数据。索引对于快速检索与索引列的值相匹配的行也非常有用。

现在我们已经了解了一些理论，让我们看看 MySQL 是如何存储我们的数据的。

### MySQL 存储数据的方式和位置

MySQL 数据库系统通过一种有趣的编程隔离机制存储数据，这种机制称为存储引擎，由处理程序接口控制。处理程序接口允许在 MySQL 服务器中使用可互换的存储组件，以便解析器、优化器和各种组件可以使用公共机制在磁盘上存储数据时进行交互。这也称为可插拔存储引擎。 <sup>[6](#Fn6)</sup> 虽然 MySQL 支持几种存储引擎，但默认的存储引擎被称为 InnoDB，这是一种事务存储引擎。

这对你意味着什么？这意味着您可以选择不同的数据存储机制，但对于大多数应用程序，您不需要更改存储引擎。如果您确实想更改存储引擎，可以在下面的代码示例所示的`CREATE TABLE`语句中指定存储引擎。请注意命令中的最后一行:这是如何指定存储引擎的。去掉这个子句会导致 MySQL 使用默认的存储引擎(InnoDB)。

```py
CREATE TABLE `books` (
  `ISBN` varchar(15) DEFAULT NULL,
  `Title` varchar(125) DEFAULT NULL,
  `Authors` varchar(100) DEFAULT NULL,
  `Quantity` int(11) DEFAULT NULL,
  `Slot` int(11) DEFAULT NULL,
  `Thumbnail` varchar(100) DEFAULT NULL,
  `Description` text
) ENGINE=MyISAM;

```

太好了。现在，MySQL 上存在哪些存储引擎？您可以通过发出以下命令来发现支持哪些存储引擎。如你所见，有很多可供选择。我将介绍一些可能与传感器网络规划相关的内容。

```py
> SELECT engine, support, transactions FROM information_schema.engines;
+--------------------+---------+--------------+
| engine             | support | transactions |
+--------------------+---------+--------------+
| ARCHIVE            | YES     | NO           |
| BLACKHOLE          | YES     | NO           |
| MRG_MYISAM         | YES     | NO           |
| FEDERATED          | NO      | NULL         |
| MyISAM             | YES     | NO           |
| PERFORMANCE_SCHEMA | YES     | NO           |
| InnoDB             | DEFAULT | YES          |
| MEMORY             | YES     | NO           |
| CSV                | YES     | NO           |
+--------------------+---------+--------------+
9 rows in set (0.0005 sec)

```

#### 通用存储引擎

从 5.6 版本开始，MySQL 默认使用 InnoDB 存储引擎。以前的版本默认使用 MyISAM。InnoDB 是一个完全事务性的，ACID <sup>[7](#Fn7)</sup> 存储引擎。事务是一批语句，在将任何更改写入磁盘之前，这些语句必须全部成功。典型的例子是银行转账。如果您考虑一个需要从一个帐户中扣除一笔金额，然后将该金额存入另一个帐户以完成资金转移的系统，您不会希望第一个帐户成功，第二个帐户失败，反之亦然！

将语句包装在一个事务中可以确保在所有语句都正确无误地完成之前，不会将任何数据写入磁盘。在这种情况下，事务由 BEGIN 语句指定，并以保存更改的`COMMIT`或撤销更改的`ROLLBACK`结束。InnoDB 将其数据存储在一个文件中(还有一些用于管理索引和事务的附加文件)。

MyISAM 存储引擎针对读取进行了优化。MyISAM 作为默认引擎已经有一段时间了，并且是第一批可用的存储引擎之一。事实上，服务器的很大一部分是专用于支持 MyISAM 的。它与 InnoDB 的不同之处在于，它不支持事务，并且以索引顺序访问方法格式存储数据。这意味着它支持快速索引。如果您不需要事务，并且希望能够移动或备份单个表，那么您应该选择 MyISAM 而不是 InnoDB。

您可能需要考虑的另一个存储引擎是归档，尤其是对于传感器网络。该引擎不支持删除(但是您可以删除整个表),并且针对磁盘上的最小存储进行了优化。很明显，如果你在一个像 Raspberry Pi 这样的小系统上运行 MySQL，最小化磁盘使用可能是一个目标。无法删除数据可能会限制更高级的应用，但大多数传感器网络只是存储数据，很少删除数据。在这种情况下，您可以考虑使用归档存储引擎。

还有 CSV 存储引擎(其中 CSV 代表逗号分隔值)。此存储引擎创建文本文件，以纯文本形式存储数据，其他应用程序(如电子表格应用程序)可以读取这些数据。如果您将传感器数据用于统计分析，CSV 存储引擎可能会使获取数据的过程更容易。

#### 我的数据存储在哪里？

那么这些数据都在哪里呢？如果您查询 MySQL 服务器并发出命令`SHOW VARIABLES LIKE 'datadir';`，您会看到所有存储引擎用来存储数据的磁盘位置的路径。对于 InnoDB，这是位于数据目录中的磁盘上的一个文件。InnoDB 也创建一些管理文件，但是数据存储在单个文件中。对于除 NDB 和内存之外的大多数其他存储引擎，表的数据存储在 data 目录下一个以数据库名称命名的文件夹中。清单 [8-2](#PC4) 给出了一个例子。数据库文件夹以粗体显示。为了简洁起见，省略了一些文件。

Tip

当您第一次使用 sudo 时，您需要输入 root 用户的密码。

```py
> SHOW VARIABLES LIKE 'datadir';
+---------------+------------------------+
| Variable_name | Value                  |
+---------------+------------------------+
| datadir       | /usr/local/mysql/data/ |
+---------------+------------------------+
1 row in set (0.0037 sec)
> \q
Bye!

$ sudo ls -lsa /usr/local/mysql/data
total 336248
    0 drwxr-x---   12 _mysql  _mysql       384 Nov  4 16:28 #innodb_temp
    0 drwxr-x---   30 _mysql  _mysql       960 Nov  4 17:05 .
    0 drwxr-xr-x   17 root    wheel        544 Nov  4 16:28 ..
    8 -rw-r-----    1 _mysql  _mysql        56 Nov  4 16:28 auto.cnf
    8 -rw-r-----    1 _mysql  _mysql       665 Nov  4 16:28 binlog.000001
  264 -rw-r-----    1 _mysql  _mysql     84608 Nov  4 17:05 binlog.000002
    8 -rw-r-----    1 _mysql  _mysql        32 Nov  4 16:28 binlog.index
    0 drwxr-x---    8 _mysql  _mysql       256 Nov  4 17:05 bvm
    8 -rw-r-----    1 _mysql  _mysql      3513 Nov  4 16:28 ib_buffer_pool
98304 -rw-r-----    1 _mysql  _mysql  50331648 Nov  4 17:05 ib_logfile0
98304 -rw-r-----    1 _mysql  _mysql  50331648 Nov  4 16:28 ib_logfile1
24576 -rw-r-----    1 _mysql  _mysql  12582912 Nov  4 17:05 ibdata1
24576 -rw-r-----    1 _mysql  _mysql  12582912 Nov  4 16:28 ibtmp1
    0 drwxr-x---    8 _mysql  _mysql       256 Nov  4 16:28 mysql
49152 -rw-r-----    1 _mysql  _mysql  25165824 Nov  4 17:05 mysql.ibd
    8 -rw-r-----    1 _mysql  _mysql       739 Nov  4 16:28 mysqld.local.err
    8 -rw-r-----    1 _mysql  _mysql         5 Nov  4 16:28 mysqld.local.pid
    0 drwxr-x---  105 _mysql  _mysql      3360 Nov  4 16:28 performance_schema
    0 drwxr-x---    3 _mysql  _mysql        96 Nov  4 16:28 sys
    0 drwxr-x---    3 _mysql  _mysql        96 Nov  4 16:36 testme
20480 -rw-r-----    1 _mysql  _mysql  10485760 Nov  4 17:05 undo_001
20480 -rw-r-----    1 _mysql  _mysql  10485760 Nov  4 17:05 undo_002

$ sudo ls -lsa /usr/local/mysql/data/bvm
total 64
 0 drwxr-x---   8 _mysql  _mysql   256 Nov  4 17:05 .
 0 drwxr-x---  30 _mysql  _mysql   960 Nov  4 17:05 ..
16 -rw-r-----   1 _mysql  _mysql  5324 Nov  4 17:05 books.MYD
 8 -rw-r-----   1 _mysql  _mysql  1024 Nov  4 17:05 books.MYI
16 -rw-r-----   1 _mysql  _mysql  8012 Nov  4 17:05 books_354.sdi
 8 -rw-r-----   1 _mysql  _mysql   281 Nov  4 17:05 settings.MYD
 8 -rw-r-----   1 _mysql  _mysql  1024 Nov  4 17:05 settings.MYI
 8 -rw-r-----   1 _mysql  _mysql  2250 Nov  4 17:05 settings_355.sdi

Listing 8-2Finding Where Your Data Is Located

```

该示例首先向数据库服务器查询数据目录的位置(它位于该计算机上受保护的文件夹中)。如果您发出一个列表命令，您可以看到由前缀`ib`和`ibd`标识的 InnoDB 文件。您还可以看到许多目录，所有这些目录都是该服务器上的数据库。下面是一个数据库文件夹的列表。注意到扩展名为`.MY`的文件吗？:这些是 MyISAM 文件(数据和索引)。

有关存储引擎及其选择和特性的更多信息，请参见在线 MySQL 参考手册“存储引擎”( [`https://dev.mysql.com/doc/refman/8.0/en/storage-engines.html`](https://dev.mysql.com/doc/refman/8.0/en/storage-engines.html) )一节。

### MySQL 配置文件

MySQL 服务器可以使用配置文件进行配置，类似于您配置 Raspberry Pi 的方式。在 Raspberry Pi 上，MySQL 配置文件位于`/etc/mysql`文件夹中，命名为`my.cnf`。该文件包含几个部分，其中一部分被标记为`[mysqld]`。该列表中的项目是键-值对:等号左边的名称是选项，它的值在右边。以下是一个典型的配置文件(为简洁起见，省略了许多行):

```py
[mysqld]
port = 3306
basedir = /usr/local/mysql
datadir = /usr/local/mysql/data
server_id = 5
general_log

```

正如您所看到的，这是一种配置系统的简单方法。本示例设置 TCP 端口、基本目录(MySQL 安装的根目录，包括数据以及二进制和辅助文件)、数据目录和服务器 ID(用于复制，稍后将讨论)并打开常规日志(当包含布尔开关时，它打开日志)。您可以为 MySQL 设置许多这样的变量。有关使用配置文件的详细信息，请参阅在线 MySQL 参考手册。当你在覆盆子 Pi 上设置 MySQL 时，你会改变这个文件。

### 如何启动、停止和重启 MySQL

在 Raspberry Pi 上使用数据库和配置 MySQL 时，您可能需要控制 MySQL 服务器的启动和关闭。安装 MySQL 的默认模式是在启动时自动启动，在关机时自动停止，但是您可能希望更改这一模式，或者您可能需要在更改参数后停止并启动服务器。此外，当您更改配置文件时，需要重新启动服务器才能看到更改的效果。

您可以使用位于`/etc/init.d/mysql`中的脚本启动、停止和重启 MySQL 服务器。以下是它的选项列表:

```py
$ /etc/init.d/mysql --help
Usage: mysql.server  {start|stop|restart|reload|force-reload|status}  [ MySQL server options ]

```

该脚本可以启动、停止和重启服务器，并获取其状态。您还可以将配置(如启动)选项传递给服务器。这对于打开临时使用的功能以替代修改配置文件非常有用。例如，如果要在一段时间内打开常规日志，可以使用以下命令:

```py
/etc/init.d/mysql restart --general-log
/etc/init.d/mysql restart

```

第一次重启以一般登录方式重启服务器，第二次重启不启用日志(假设日志不在配置文件中)。重新启动服务器时，最好确保没有人在使用它。

然而，在最新版本的 Raspbian 上启动和停止 MySQL 的更好方法是使用如下的`systemctl`命令。你可以使用任何一种方法。

*   *开始* : `sudo systemctl start mysqld`

*   *停止* : `sudo systemctl stop mysqld`

*   *重启* : `sudo systemctl restart mysqld`

*   *状态* : `sudo systemctl status mysqld`

Shutting Down Correctly

您可能会像关闭 Arduino 传感器节点一样关闭 Raspberry Pi 数据库服务器，但是您应该避免这种诱惑。Raspberry Pi 是一台真正的计算机，具有需要同步关机的活动文件系统。断电前，您应该始终执行受控关机。

要关闭 Raspberry Pi，回想一下您发出了`sudo shutdown –h now`命令。要重新启动，您可以使用`sudo shutdown –r now`命令。

### 创建用户和授予访问权限

在使用 MySQL 之前，您需要了解另外两个管理操作:创建用户帐户和授予数据库访问权限。MySQL 可以用`CREATE USER`和一个或多个`GRANT`语句来执行这两个任务。例如，下面显示了名为 sensor1 的用户的创建，并授予该用户对数据库`room_temp`的访问权限:

```py
CREATE USER 'sensor1'@'%' IDENTIFIED BY 'secret';
GRANT SELECT, INSERT, UPDATE ON room_temp.∗ TO 'sensor1'@'%';

```

第一个命令创建名为`sensor1`的用户，但是该名称也有一个`@`后跟另一个字符串。第二个字符串是与用户相关联的机器的主机名。也就是说，MySQL 中的每个用户都有一个用户名和一个主机名，以`user@host`的形式唯一地标识他们。这意味着用户和主机`sensor1@10.0.1.16`以及用户和主机`sensor1@10.0.1.17`是不同的。但是，`%`符号可以用作通配符，将用户与任何主机关联起来。`IDENTIFIED BY`子句为用户设置密码。

A Note About Security

为您的应用程序创建一个对 MySQL 系统没有完全访问权限的用户总是一个好主意。这是为了最大限度地减少任何意外更改，也是为了防止被利用。对于传感器网络，建议您创建一个只能访问存储(或检索)数据的数据库的用户。您可以使用以下命令更改 MySQL 用户密码:

```py
ALTER USER sensor1@"%" IDENTIFIED BY 'super_secret';

```

对于主机使用通配符%也要小心。虽然创建单个用户并让用户从任何主机访问数据库服务器变得更加容易，但这也使得恶意用户更容易访问您的服务器(一旦他们发现了密码)。

另一个考虑是连接性。与 Raspberry Pi 一样，如果您将一个数据库连接到您的网络，而该网络又连接到 Internet，那么您的网络或 Internet 上的其他用户就有可能访问该数据库。不要让他们轻易得逞——更改您的 root 用户密码，并为您的应用程序创建用户。

第二个命令允许访问数据库。您可以授予用户许多权限。该示例显示了您想要给传感器网络数据库的用户的最可能的集合:读取(`SELECT`)、<sup>、、</sup>、添加数据(`INSERT`)和改变数据(`UPDATE`)。有关安全性和帐户访问权限的更多信息，请参见在线参考手册。

该命令还指定要授予权限的数据库和对象。因此，可以给用户一些表的读(`SELECT`)权限，给另一些表的写(`INSERT`、`UPDATE`)权限。这个例子让用户可以访问`room_temp`数据库中的所有对象(表、视图等等)。

现在您已经对 MySQL 有了一个简短的介绍，让我们从 MySQL Raspberry Pi 数据库服务器开始吧。

## 构建 Raspberry Pi MySQL 服务器

是时候弄脏你的手，在你毫无戒心的树莓派上施展魔法了！让我们从给它添加一个 USB 驱动器开始。具有快速读/写速度的闪存驱动器可以特别好地工作，因为它不需要像传统的外部硬盘驱动器那样多的功率。根据数据的大小，您可能需要认真考虑这样做。

如果您的数据很小(从不超过几兆字节)，您可以从您的启动映像 SD 卡使用 MySQL。但是，如果您想确保不会耗尽空间并保持数据与启动映像分开，您应该安装一个在启动时自动连接的 USB 驱动器。本节详细解释了如何做到这一点。

如果您计划使用外置硬盘，请确保使用高质量的 USB 集线器来存放外置硬盘。如果你使用的是传统的主轴驱动，这一点尤其重要，因为它会消耗更多的能量。将外部驱动器直接连接到 Raspberry Pi 可能会剥夺它的电源并导致无尽的沮丧。症状包括随机重启(总是令人惊喜)、命令失败、数据丢失等等。请务必为您的外围设备和 Raspberry Pi 提供充足的电源。

使用什么样的磁盘由您决定。你可以使用 USB 闪存驱动器，如果它有足够的空间和足够的速度(大多数新型号都很快)，应该可以正常工作。如果您有额外的固态硬盘或者想要将功耗和热量降至最低，您也可以使用固态硬盘(SSD)。另一方面，你可能有一个额外的硬盘可以使用。本节的示例使用安装在典型 USB 硬盘驱动器外壳中的剩余 250GB 笔记本电脑硬盘驱动器。

Tip

使用外部硬盘驱动器(SSD 或传统的主轴驱动器)比访问闪存驱动器上的数据要快得多。它通常每单位(千兆字节)更便宜，或者，正如我提到的，可以很容易地从盈余。

### 对驱动器进行分区和格式化

在使用与 Raspberry Pi 不兼容的文件系统的新驱动器或现有驱动器之前，必须对驱动器进行分区和格式化。因为这个例子中的剩余驱动器上有一个旧的 Windows 分区，所以我必须遵循这些步骤。你的 Raspberry 操作系统可能能够读取你的旧驱动器的格式，但是你应该使用`ext4`文件系统以获得最佳性能。本节向您展示如何对您的驱动器进行分区和格式化。

首先，将驱动器连接到树莓派。然后使用`fdisk`命令确定连接了哪些驱动器，如下所示:

```py
$ sudo fdisk -l
...
Disk /dev/sda: 59.2 GiB, 63518539776 bytes, 124059648 sectors
Disk model: Cruzer Fit
Units: sectors of 1 ∗ 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xde217a25

Device     Boot   Start      End  Sectors  Size  Id  Type
/dev/sda1  ∗         64  6691199  6691136  3.2G  17  Hidden HPFS/NTFS
/dev/sda2       6691200  6692671     1472  736K   1  FAT12

```

你在这里看到的是所有连接到树莓派的设备。如果您是 Linux 或分区驱动器的新手，这可能看起来像是一派胡言。我用粗体突出显示了有趣的行。注意，输出标识了位于指定为`/dev/sda`的设备上的 64GB 驱动器。所有关于硬盘的有趣数据也会显示出来。

正如我提到的，这个驱动器上已经有一个分区，由带有设备名称和分区号的行来表示。因此，`/dev/sda1`是该驱动器上唯一的分区。让我们删除该分区并创建一个新分区。您使用清单 [8-3](#PC11) 中所示的`fdisk`应用程序来执行这两个操作。

Caution

如果您的驱动器上有一个分区包含您想要保留的数据，请立即中止，并首先将数据复制到另一个驱动器。以下步骤将擦除驱动器上的所有数据！

```py
$ sudo fdisk /dev/sda

Welcome to fdisk (util-linux 2.33.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Command (m for help): p

Disk /dev/sda: 59.2 GiB, 63518539776 bytes, 124059648 sectors
Disk model: Cruzer Fit
Units: sectors of 1 ∗ 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xde217a25

Device     Boot   Start     End Sectors  Size Id Type
/dev/sda1  ∗         64 6691199 6691136  3.2G 17 Hidden HPFS/NTFS
/dev/sda2       6691200 6692671    1472  736K  1 FAT12

Command (m for help): d
Partition number (1,2, default 2):

Partition 2 has been deleted

.

Command (m for help): d
Selected partition 1
Partition 1 has been deleted.

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-124059647, default 2048):
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-124059647, default 124059647):

Created a new partition 1 of type 'Linux' and of size 59.2 GiB.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.

Listing 8-3Partitioning the USB Drive

```

第一个命令`d`，删除一个分区。在这种情况下，只有一个分区，所以通过输入`1`来选择它。然后使用命令 n 创建一个新的分区，并接受缺省值，使用所有的可用空间。为了检查你的工作，你可以使用`p`命令来打印设备分区表和元数据。它显示(并确认)新的分区。

如果你担心你可能犯了一个错误，不要惊慌！关于`fdisk`的伟大之处在于，它不会写或改变磁盘，直到你用`w`或写命令告诉它。在示例中，您发出`w`命令来写入分区表。要查看可用命令的完整列表，您可以使用`h`命令或运行`man fdisk`。

Tip

对于所有的 Linux 命令，您可以使用命令`man <application>`查看手册文件。

下一步是用`ext4`文件系统格式化驱动器。这很简单，只需要一个命令:`mkfs` (make file system)。你把设备名传给它。如果你记得的话，这是`/dev/sda1`。即使您创建了一个新分区，它仍然是第一个分区，因为驱动器上只有一个分区。如果您尝试使用不同的分区，请确保使用正确的编号！该命令可能需要几分钟时间来运行，具体取决于驱动器的大小。清单 [8-4](#PC12) 展示了运行中的命令。

```py
$ sudo mkfs.ext4 /dev/sda
mke2fs 1.44.5 (15-Dec-2018)
/dev/sda contains an iso9660 file system labelled 'Backup'
Proceed anyway? (y,N) y
Creating filesystem with 15507456 4k blocks and 3883008 inodes
Filesystem UUID: d370c755-18be-4c7f-bf66-4dd666ade676
Superblock backups stored on blocks:
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 4096000, 7962624, 11239424

Allocating group tables: done
Writing inode tables: done
Creating journal (65536 blocks): done
Writing superblocks and filesystem accounting information: done

Listing 8-4Formatting the Drive

```

现在您有了一个新的分区，并且已经正确格式化了。下一步是将驱动器与引导映像上的挂载点相关联，然后在引导时连接该驱动器，这样每次启动 Raspberry Pi 时，您都不必做任何事情来使用该驱动器。

### 设置自动驱动安装

Linux 中的外置驱动器通过`mount`连接(挂载)，通过`umount`断开(卸载)。与某些操作系统不同，不先卸载就拔掉 USB 驱动器通常不是个好主意。同样，您必须先安装驱动器，然后才能使用它。本节说明了安装驱动器并使驱动器在每次引导时自动安装所需的步骤。

我首先讨论安装驱动器并为自动安装做好准备的预备步骤。这些包括在`/media`文件夹下创建一个文件夹来挂载驱动器(称为挂载点)，更改文件夹的权限以允许访问，以及执行一些可选步骤来调整驱动器:

```py
$ sudo mkdir /media/mysql
$ sudo chmod 755 /media/mysql
$ sudo tune2fs -m 0 /dev/sda
tune2fs 1.44.5 (15-Dec-2018)
Setting reserved blocks percentage to 0% (0 blocks)
$ sudo tune2fs -L MySQL /dev/sda
tune2fs 1.44.5 (15-Dec-2018)
$ sudo mount /dev/sda /media/mysql
$ sudo ls -lsa /media/mysql
total 24
 4 drwxr-xr-x 3 root root  4096 Nov 27 13:44 .
 4 drwxr-xr-x 4 root root  4096 Nov 27 13:55 ..
16 drwx------ 2 root root 16384 Nov 27 13:44 lost+found

```

这些命令很容易识别，是基本的文件和文件夹命令。但是，使用`tune2fs`(调整文件系统)的调整步骤用于首先重置用于特权访问的块数(这样可以节省一点空间)，然后将驱动器标记为`MYSQL`。同样，这些是可选的，如果你愿意，你可以跳过它们。

Tip

可以用`sudo umount /dev/sda1`卸载驱动器。

此时，驱动器可以访问并准备好使用。你可以切换到`/media/HDD`文件夹，创建文件或者做任何你想做的事情。现在，让我们来完成为自动挂载设置驱动器的任务。

最好的方法是通过驱动器的通用唯一标识符(UUID)来引用它。这被分配给这个驱动器，并且只分配给这个驱动器。您可以告诉操作系统将具有特定 UUID 的驱动器挂载到特定的挂载点(/media/HDD)。

还记得之前的`/dev/sda`设备名称吗？如果您将驱动器插入另一个集线器端口，或者更好的情况是，如果有其他驱动器连接到您的设备，并且您卸载然后再装载它们，则下次引导时设备名称可能会不同！UUID 帮助您确定哪个驱动器是您的数据驱动器，使您不必将驱动器插入特定的端口，并允许您使用其他驱动器，而不必担心如果驱动器被赋予不同的设备名称会破坏您的 MySQL 安装。

要获得 UUID，使用`blkid`(块 ID)应用程序:

```py
$ sudo blkid
...
/dev/sda: LABEL="MySQL" UUID="d370c755-18be-4c7f-bf66-4dd666ade676" TYPE="ext4"
...

```

注意粗体的那一行。哇哦！那是一大串。UUID 是一个 128 字节(字符)的字符串。为下一步复制它。

要设置自动驱动器映射，您可以使用一个称为文件系统静态信息的特性(`fstab`)。这包括位于系统上的`/etc`文件夹中的一个文件。你可以随意编辑这个文件。如果你来自 Linux 或 Unix 的老学校，你可能会选择使用`vi`。 <sup>[9](#Fn9)</sup> 由此产生的文件如下:

```py
$ sudo nano /etc/fstab
proc    /proc   proc    defaults  0       0
/dev/mmcblk0p1  /boot   vfat    defaults  0       0
/dev/mmcblk0p2  /       ext4    defaults,noatime  0       0
UUID= d370c755-18be-4c7f-bf66-4dd666ade676 /media/mysql   ext4   defaults,noatime   0   0

```

您添加的行以粗体显示。在这里，您只需添加 UUID、挂载点、文件系统和选项。就这样！您可以使用以下命令重启您的 Raspberry Pi，并在消息滚动时观察屏幕。最终，您会看到驱动器已安装。如果出现错误，您可以在启动序列中看到它:

```py
$ sudo shutdown –r now

```

现在您已经准备好构建 MySQL 数据库服务器了！下一节详细介绍了使用 Raspberry Pi 实现这一点所需的步骤。

### 项目:在 Raspberry Pi 上安装 MySQL 服务器

将 Raspberry Pi 转变成 MySQL 数据库服务器很容易。嗯，差不多了。最新版本的 MySQL (8.0)不适用于 Raspberry Pi。 <sup>[10](#Fn10)</sup> 然而，由于 MySQL 是开源的，我们可以在我们的 Raspberry Pi 上从源代码构建(编译和链接)MySQL。多酷啊。本节将向您展示如何获取 MySQL 的源代码、构建和安装它。然后，我们将了解如何将其默认数据目录从您的引导映像移动到您在上一节中连接的新外部驱动器。

What about Other MYSQL Variants?

精明的读者可能已经知道其他供应商提供的 MySQL 的变体。虽然大多数都声称与 Oracle 的 MySQL(源代码所有者)100%兼容，但仍有一些差异会使开发更加困难。例如，已知用于 Arduino 的 MySQL 数据库连接器(称为连接器/Arduino)在某些版本的某些变体中存在问题。因此，作者认为你应该总是使用 Oracle 发布的 MySQL，而不是它的变体。

在本节中，我们将使用 Raspberry Pi 计算机，而不是更昂贵的主流服务器硬件。如果您想继续使用更传统的服务器硬件，您可以这样做，但是请记住，Raspberry Pi 上使用的一些命令与您在典型的基于 Linux 的平台上使用的命令非常相似。您可能需要替换特定于平台的版本，以便在您的 PC 上使用以下软件。

回想一下，由于 MySQL 是开源的，我们可以自己下载源代码、编译和安装。事实上，我们将在本演练中做到这一点。下面列出了准备使用 MySQL 的 Raspberry Pi 计算机的必要步骤:

*   构建 MySQL。

*   手动安装 MySQL。

*   配置 MySQL。

这个列表类似于您在商用硬件上设置 MySQL 的过程，但是构建和配置步骤是使 MySQL 在 Raspbian 上工作所必需的(因为没有安装包)。值得注意的是，这些额外的步骤并不是 Raspbian 独有的。

事实上，从源代码构建、安装和配置 MySQL 是使用安装包的可行替代方案。您可以在在线参考手册( [`https://dev.mysql.com/doc/refman/8.0/en/source-installation.html`](https://dev.mysql.com/doc/refman/8.0/en/source-installation.html) )的“从源代码安装 MySQL”一节中找到为各种平台构建 MySQL 的说明。

这个过程很简单，包括一些次要的系统配置项来准备我们的系统和两个命令:`cmake`和`make`。这一节将通过大量的例子和每一步的文档来引导你完成所有这些步骤。

从源代码构建 MySQL 的任务对于那些从来没有编程过的人或者已经有一段时间没有编写过程序的人来说可能会令人望而生畏，但是不要绝望。在 Raspberry Pi 上编译 MySQL 最困难的部分是等待过程完成。也就是说，可能要花一个小时左右的时间来编译所有的东西。但是对于能够使用 Raspberry Pi 计算机来试验 MySQL 来说，这是一个很小的代价！

让我们从先决条件开始，深入研究在 Raspbian 上编译 MySQL。

#### 先决条件

你需要安装一些东西来准备你的 Raspberry Pi 来编译 MySQL，包括硬件和软件先决条件。

硬件要求是 MySQL 的最新版本(撰写本文时是 8.0.18)要求使用 2GB 或 4GB (4GB 更快)主板的 Raspberry Pi 4B。因此，您应该考虑是否要在安装 MySQL 的同一个 Raspberry Pi 4B 上构建它。为什么这很重要？这很重要，因为你可能想在旧的 Raspberry Pi 板上运行 MySQL。更具体地说，虽然最好在 4B 上编译 MySQL，但你可以在 3B+上安装和运行它，不会有任何问题。我们将在后面看到如何做到这一点。我们需要使用 4B 的主要原因是内存。MySQL 只需要超过 3B 主板上 1GB 的内存。 <sup>[11](#Fn11)</sup>

除了需要 Raspberry Pi 4B 之外，软件先决条件还包括以下软件:

*   你需要安装诅咒 5 ( `libncurses5-dev`)。

*   你需要安装 Bison。

*   需要安装 OpenSSL ( `libssl-dev`)。

*   您需要安装 CMake。

要一次安装所有这些库，请在终端窗口中使用以下命令。这将下载并安装必要的文件。请注意，我们必须使用提升的权限来安装库。

```py
$ sudo apt-get install libncurses5-dev bison libssl-dev cmake

```

唯一的其他先决条件是，我们必须下载 MySQL 服务器的源代码。进入 [`https://dev.mysql.com/downloads/mysql/`](https://dev.mysql.com/downloads/mysql/) ，在*选择操作系统*下拉框中选择*源代码*，在*选择 OS 版本*下拉框中选择*通用 Linux* ，然后点击列表底部的通用 Linux(架构无关)，压缩的 TAR 存档包含 Boost 头文件下载链接，如图 [8-1](#Fig1) 所示。这个文件包含我们需要的另一个库(boost)以及服务器源代码。这是最容易开始构建的下载。一旦你下载了文件，把它复制到你的 Raspberry Pi。

![../images/313992_2_En_8_Chapter/313992_2_En_8_Fig1_HTML.jpg](../images/313992_2_En_8_Chapter/313992_2_En_8_Fig1_HTML.jpg)

图 8-1

下载 MySQL 服务器源代码

好了，现在我们准备好构建 MySQL 服务器了。

#### 构建 MySQL 服务器

在 Raspberry Pi 上构建 MySQL 只需要三个步骤。我们首先运行名为 CMake 的预处理器，然后用 Make 构建代码，最后用 make package 命令构建安装包。我们可以用这个包在另一个 Raspberry Pi 上安装 MySQL。让我们从 CMake 开始，看看每个步骤的细节。

CMake ( `cmake.org`)是另一个用于构建、测试和打包软件的开源产品。回想一下，我们在上一节安装了 CMake。您可以使用许多不同的选项来构建软件，其中许多也适用于 MySQL。事实上，您可以花费大量时间定制 CMake 命令选项，以便为几乎任何平台进行构建。由于我们下载了带有 Boost 库的普通 Linux 的 MySQL 源代码，我们已经得到了我们需要的一切。

因此，我们需要使用 CMake 的命令选项很少，包括以下内容。这里将对每一项进行更详细的解释:

*   你应该设置`-DWITH_UNIT_TESTS=OFF`来节省编译时间(不需要)。

*   您应该设置`PREFIX`来设置安装路径，以便于安装。

*   我们需要关掉“黄金”连接器。

*   我们必须用发布代码来构建(debug 对于 Raspberry Pi 来说需要太多内存)。

*   我们必须添加额外的编译和构建标志，以确保代码在 ARM32 上正确构建。

##### 运行 CMake(准备编译)

我们要做的第一件事是提取我们下载的 TAR 文件。您可以使用以下命令来实现这一点。这将创建一个名为 mysql-8.0.18 的文件夹。建议您将此文件解压缩到 root 用户个人文件夹中的一个文件夹中，例如`/home/pi/source`。解压缩过程将需要几分钟时间，因为它包含大量代码。

```py
$ cd /home/pi
$ mkdir source
$ cd source
$ cp ~/Downloads/mysql-boost-8.0.18.tar.gz .
$ tar -xvf mysql-boost-8.0.18.tar.gz

```

接下来，我们将使用以下命令创建一个目录来存储所有编译后的代码。这有助于防止编译时发生意外，并保留源代码。

```py
$ cd mysql-8.0.18
$ mkdir build
$ cd build

```

现在我们可以运行 CMake 命令了。清单 [8-5](#PC20) 显示了您需要在`build`文件夹中使用的完整命令。请注意，该命令指定了许多选项，包括(按出现的顺序)使用 Unix makefiles、将构建设置为发布代码(而不是调试)、忽略 AIO 检查、设置 boost 文件夹(包含在我们下载的 TAR 文件中)、关闭单元测试，以及为 ARM32 上的编译设置一些神秘的设置。

```py
$ cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=release -DBUILD_CONFIG=mysql_release -DDEBUG_EXTNAME=OFF -DIGNORE_AIO_CHECK=1 -DWITH_UNIT_TESTS=OFF -DCMAKE_C_LINK_FLAGS="-Wl,--no-keep-memory,-latomic" -DCMAKE_CXX_LINK_FLAGS="-Wl,--no-keep-memory,-latomic" -DCMAKE_C_FLAGS_RELEASE="-fPIC" -DCMAKE_CXX_FLAGS_RELEASE="-fPIC" -DCMAKE_INSTALL_PREFIX="/usr/local/mysql" -DUSE_LD_GOLD=OFF -DWITH_BOOST="../boost" ..
-- Running cmake version 3.13.4
-- Found Git: /usr/bin/git (found version "2.20.1")
-- MySQL 8.0.18
-- Source directory /media/pi/source/mysql-8.0.18
-- Binary directory /media/pi/source/mysql-8.0.18/build
-- CMAKE_GENERATOR: Unix Makefiles
...
-- CMAKE_C_FLAGS: -fno-omit-frame-pointer  -Wall -Wextra -Wformat-security -Wvla -Wundef -Wwrite-strings -Wjump-misses-init
-- CMAKE_CXX_FLAGS: -std=c++14 -fno-omit-frame-pointer  -Wall -Wextra -Wformat-security -Wvla -Wundef -Woverloaded-virtual -Wcast-qual -Wimplicit-fallthrough=2 -Wlogical-op
-- CMAKE_CXX_FLAGS_DEBUG: -DSAFE_MUTEX -DENABLED_DEBUG_SYNC -g
-- CMAKE_CXX_FLAGS_RELWITHDEBINFO: -DDBUG_OFF -ffunction-sections -fdata-sections -O2 -g -DNDEBUG
-- CMAKE_CXX_FLAGS_RELEASE: -DDBUG_OFF -ffunction-sections -fdata-sections -fPIC
-- CMAKE_CXX_FLAGS_MINSIZEREL: -DDBUG_OFF -ffunction-sections -fdata-sections -Os -DNDEBUG
-- CMAKE_C_LINK_FLAGS: -Wl,--no-keep-memory,-latomic
-- CMAKE_CXX_LINK_FLAGS: -Wl,--no-keep-memory,-latomic
-- CMAKE_EXE_LINKER_FLAGS
-- CMAKE_MODULE_LINKER_FLAGS
-- CMAKE_SHARED_LINKER_FLAGS
-- Configuring done
-- Generating done

Listing 8-5Running the CMake Command (ARM32)

```

如果这个命令看起来很奇怪，不要担心，也没有必要理解我们在编译和链接阶段使用的所有特殊设置。但是，如果您确实想了解更多关于这些选项的信息，您可以查看关于 GNU 编译器( [`http://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html`](http://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html) )和链接器( [`https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html`](https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html) )选项的文档。

运行该命令可能需要几分钟时间。确保没有错误，并且最后几行表明构建文件已经写入构建文件夹。请特别注意结尾的`LINK_FLAGS`消息。CMake 命令中的选项不包括空格。如果您不小心添加了空格，逗号分隔的列表会在 CMake 输出中显示它们。确保没有空格。如果有空格，您可能会得到一个错误，指出`--icf=safe`(或其他)选项无效。如果发生这种情况，请再次运行不带空格的命令。

如果你已经走了这么远而没有错误，你几乎可以放松了。下一步，编译代码很容易，但在 Raspberry Pi 4B 上运行需要一段时间(至少 1-2 小时)。

##### 运行 Make(编译)

下一步是编译代码。这可以通过 make 命令简单地完成。这个命令允许我们指定想要使用多少个并行线程。对于 Raspberry Pi 4B 和总共四个 CPU 内核，使用三个内核进行编译是安全的。如果您有一个正在运行的 CPU 使用监视器，您将会看到这三个内核，有时可能是所有四个内核都在 100%运行。如果你的树莓皮是装在盒子里的，确保你有足够的通风或风扇吹过电路板。

清单 [8-6](#PC21) 显示了使用命令`make -j3`编译 MySQL 服务器代码的步骤。该清单是您可能会看到的消息的摘录(将有数千行)，但需要注意的是最后几行。这些确保代码编译无误。

Tip

在代码编译时，您可能会看到轻微的警告，您可以忽略这些警告。但是，您应该看不到任何编译错误。如果是这样，请返回检查 CMake 命令，并在必要时重新运行它。如果所有这些都失败了，删除构建目录并重新开始。

```py
$ make -j3
[  0%] Built target INFO_SRC
[  0%] Built target INFO_BIN
[  0%] Building C object extra/zlib/CMakeFiles/zlib_objlib.dir/gzread.o
[  0%] Building C object extra/zstd/CMakeFiles/zstd_objlib.dir/lib/common/threading.c.o
[  0%] Building C object extra/zstd/CMakeFiles/zstd_objlib.dir/lib/common/xxhash.c.o
[  0%] Building C object extra/zlib/CMakeFiles/zlib_objlib.dir/gzwrite.o
...
[100%] Building CXX object storage/innobase/CMakeFiles/innobase.dir/os/os0thread.cc.o
[100%] Building CXX object storage/innobase/CMakeFiles/innobase.dir/page/zipdecompress.cc.o
[100%] Building CXX object storage/innobase/CMakeFiles/innobase.dir/rem/rec.cc.o
[100%] Building CXX object storage/innobase/CMakeFiles/innobase.dir/ut/crc32.cc.o
[100%] Building CXX object storage/innobase/CMakeFiles/innobase.dir/ut/ut.cc.o
[100%] Linking CXX static library libinnobase.a
[100%] Built target innobase
Scanning dependencies of target mysqld
[100%] Building CXX object sql/CMakeFiles/mysqld.dir/main.cc.o
[100%] Linking CXX executable ../runtime_output_directory/mysqld
[100%] Built target mysqld

Listing 8-6Compiling MySQL Server

```

编译完成后，下一步是构建一个包(TAR 文件),我们可以用它在我们的服务器上安装 MySQL。

##### 制作包装

我们需要做的最后一件事是构建安装包。在这种情况下，我们将构建一个压缩 TAR 文件，我们可以将它复制到我们的初始服务器并进行安装。我们使用清单 [8-7](#PC22) 中所示的 make package 命令来实现这一点。

```py
$ make package
[  0%] Built target abi_check
[  0%] Built target INFO_SRC
[  0%] Built target INFO_BIN
[  1%] Built target zlib_objlib
[  1%] Built target zlib
[  2%] Built target zstd_objlib
[  2%] Built target zstd
[  3%] Built target edit
[  4%] Built target event_core
...
[100%] Built target routing
[100%] Built target rest_routing
[100%] Built target mysqlrouter
[100%] Built target mysqlrouter_keyring
Run CPack packaging tool...
CPack: Create package using TGZ
CPack: Install projects
CPack: - Run preinstall target for: MySQL
CPack: - Install project: MySQL
CPack: Create package
CPack: - package: /home/pi/source/mysql-8.0.18/build/mysql-8.0.18-linux-armv7l.tar.gz generated.

Listing 8-7Building the TAR Package

```

就是这样！我们在 Raspberry Pi 上构建了 MySQL！还不算太糟，是吧？现在，让我们看看如何在我们的服务器上安装和测试 MySQL。

#### 安装 MySQL 服务器

如果我们在不同的 Raspberry Pi 上构建 MySQL，我们需要将 TAR 文件复制到一个可移动驱动器上，以便将该文件复制到目标 Raspberry Pi 上。

一旦服务器启动，登录并切换到`/usr/local`目录，创建一个名为`mysql`的新文件夹。然后，切换到新文件夹，并将 TAR 文件复制到该文件夹。最后，使用以下命令解压文件。有很多文件，所以解压缩可能需要几分钟时间。

```py
$ cd /usr/local/
$ mkdir mysql
$ cd mysql
$ sudo cp ~/source/mysql-8.0.11/build/mysql-8.0.18-linux-armv7l.tar.gz .
$ sudo tar -xvf mysql-8.0.11-linux-armv7l.tar.gz --strip-components=1

```

注意，最后一个命令使用一个选项从提取的文件目录中删除一个组件(第一个文件夹— `mysql-8.0.18-linux-armv71`)。这确保了 MySQL 文件被复制到`/usr/local/mysql`。

但是，我们还需要运行一个命令。因为我们是太空良心，我们不需要 MySQL 测试文件，所以我们可以用下面的命令删除它们。一旦我们完成了 TAR 文件，我们也可以删除它，如下所示:

```py
$ sudo rm -rf mysql-test
$ sudo rm mysql-8.0.18-linux-armv71.tar.gz

```

从 TAR 文件安装比从典型的特定于平台的包安装需要更多的步骤。这是因为安装包通常负责几个必需的配置步骤，所有这些都在在线参考手册中题为“使用通用二进制文件在 Unix/Linux 上安装 MySQL”([`https://dev.mysql.com/doc/refman/8.0/en/binary-installation.html`](https://dev.mysql.com/doc/refman/8.0/en/binary-installation.html))的章节中有详细说明。

#### 配置 MySQL 服务器

现在我们已经复制了文件，我们可以完成设置。这个过程并不繁琐，但确实涉及到从终端运行几个命令，所以需要一些耐心来确保所有命令都输入正确。

我们首先创建一个名为`mysql`的新组，然后添加一个名为`mysql`的用户，然后创建一个供 MySQL 使用的文件夹，并授予`mysql`用户对该文件夹的访问权限。以下代码显示了所需的命令。从终端运行这些命令(任何命令都不会有输出)。

```py
$ sudo groupadd mysql
$ sudo useradd -r -g mysql -s /bin/false mysql
$ cd /usr/local/mysql
$ sudo mkdir mysql-files
$ sudo chown mysql:mysql mysql-files
$ sudo chmod 750 mysql-files

```

我们可以用下面的代码所示的`--initialize`选项轻松初始化数据目录。注意，我们使用提升的权限运行命令，并指定要使用的用户(mysql)。以下代码显示了突出显示成功消息的输出示例。如果您看到错误，请参考在线参考手册来解决错误。请注意，输出包含初始 root 用户密码。下一步您将需要它。请注意，此步骤可能需要一些时间来运行。

```py
$ sudo ./bin/mysqld --initialize --user=mysql
2019-11-17T02:02:41.118355Z 0 [System] [MY-013169] [Server] /usr/local/mysql/bin/mysqld (mysqld 8.0.18) initializing of server in progress as process 7704
2019-11-17T02:05:04.757386Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: VPw&eFjU-0z#

```

接下来，我们使用我们最喜欢的编辑器创建一个配置文件，如下所示:

```py
$ sudo vi /etc/my /etc/my.cnf

```

将以下几行添加到配置文件中并保存(按下 *Esc* 然后*:，*然后 *w，*然后 *q* )。在下一步中，我们将使用这个配置文件来启动服务器。

```py
[mysqld]
basedir=/usr/local/mysql/
datadir=/usr/local/mysql/data

```

好了，我们现在准备好第一次启动 MySQL 了。使用`mysqld`命令从命令行启动 MySQL。我们使用这个命令代替`/etc/init.d/mysql start`命令，这样我们可以检查输出中的错误。如果没有错误，您应该会看到如下所示的输出:

```py
$ sudo bin/mysqld --defaults-file=/etc/my.cnf --user=mysql &
[1] 8745
$ 2019-11-17T02:09:41.429418Z 0 [Warning] [MY-011037] [Server] The CYCLE timer is not available. WAIT events in the performance_schema will not be timed.
2019-11-17T02:09:42.191155Z 0 [System] [MY-010116] [Server] /usr/local/mysql/bin/mysqld (mysqld 8.0.18) starting as process 8750
2019-11-17T02:09:58.600980Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
2019-11-17T02:09:59.167758Z 0 [System] [MY-010931] [Server] /usr/local/mysql/bin/mysqld: ready for connections. Version: '8.0.18'  socket: '/tmp/mysql.sock'  port: 3306  Source distribution.
2019-11-17T02:09:59.378833Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: '/tmp/mysqlx.sock' bind-address: '::' port: 33060

```

现在我们可以使用下面的命令用 mysql 客户端测试我们的 MySQL 服务器。确保使用初始化数据目录时显示的密码。清单 [8-8](#PC30) 展示了第一次使用`mysql`客户端连接到服务器的例子。我们将首先显示版本，然后更改 root 用户密码。注意，我们还使用 shutdown SQL 命令关闭了服务器。

```py
$ bin/mysql -uroot -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.18

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> SELECT @@version;
+-----------+
| @@version |
+-----------+
| 8.0.18    |
+-----------+
1 row in set (0.00 sec)

mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'secret';
Query OK, 0 rows affected (0.11 sec)

mysql> shutdown;
Query OK, 0 rows affected (0.00 sec)

mysql> \q

Listing 8-8Connecting to MySQL for the First Time

```

接下来，我们必须添加 MySQL 二进制文件的路径。通过使用命令`nano ~/.bashrc`编辑 Bash 资源文件，我们可以很容易地做到这一点。当文件打开时，在文件的底部添加下面一行。下次打开终端时，无需指定路径就可以执行 MySQL 应用程序和工具。

```py
export PATH=${PATH}:/usr/local/mysql/bin

```

还需要最后一步——我们必须复制启动和关闭脚本(服务),以便在启动时自动启动 MySQL。为此，从构建的`support-files`文件夹中复制`mysql.server`文件到`/etc/init.d/mysql`文件，如清单 [8-9](#PC32) 所示。我们还将再次测试服务器连接，然后使用`sudo systemctl daemon-reload`命令刷新守护进程列表，使用`sudo systemctl start`或`sudo systemctl stop`命令启动或停止 MySQL，从而关闭服务器连接。你也可以使用`sudo systemctl status`命令来查看 MySQL 的状态。如果您遇到错误或想要检查 MySQL 是否正在运行，这可能会很有帮助。请注意，使用该命令时，系统可能会提示您输入密码。另外，您希望从`build`目录中复制`mysql.server`文件，而不是源代码目录的根目录。

```py
$ sudo cp ./support-files/mysql.server /etc/init.d/mysql
$ sudo chmod 0755 /etc/init.d/mysql
$ sudo systemctl daemon-reload
$ sudo systemctl start mysql
$ sudo systemctl status mysql
● mysql.service - LSB: start and stop MySQL
   Loaded: loaded (/etc/init.d/mysql; generated)
   Active: active (running) since Sat 2019-11-16 21:22:44 EST; 6s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 11023 ExecStart=/etc/init.d/mysql start (code=exited, status=0/SUCCESS)
    Tasks: 40 (limit: 2200)
   Memory: 350.5M
   CGroup: /system.slice/mysql.service
           ├─11037 /bin/sh /usr/local/mysql//bin/mysqld_safe --datadir=/usr/local/mysql/data --
           └─11148 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql/ --datadir=/usr/local

...
Nov 16 21:22:44 raspberrypi systemd[1]: Started LSB: start and stop MySQL.

$ mysql -uroot -p -e "select @@version"
Enter password:
+-----------+
| @@version |
+-----------+
| 8.0.18    |
+-----------+
$ sudo systemctl stop mysql
$ sudo systemctl status mysql
...
Nov 16 21:23:02 raspberrypi systemd[1]: Stopped LSB: start and stop MySQL.

Listing 8-9Starting MySQL Automatically or Manually with systemctl

```

就这样！我们已经安装了 MySQL 服务器，并测试了它的工作情况。在每台服务器上安装 MySQL Shell 也是一个好主意。在下一节中，您将告诉 MySQL 使用外部驱动器来存储您的数据库和数据。

#### 将数据目录移动到外部驱动器

回想一下，您希望使用 MySQL 来存储您的传感器数据。因此，传感器数据的量可能会增长，并且随着时间的推移可能会消耗大量空间。您可以使用外部驱动器来保存数据，而不必冒填满启动映像 SD(通常只有几千兆字节)的风险。这一节将向您展示如何告诉 MySQL 更改其保存数据的默认位置。

所涉及的步骤需要停止 MySQL 服务器，更改其配置，然后重新启动服务器。最后，测试更改以确保所有新数据都保存在新位置。首先停止 MySQL 服务器:

```py
$ sudo systemctl stop mysql

```

您必须为新数据目录创建一个文件夹:

```py
$ sudo mkdir /media/mysql/mysql_data

```

现在，您将现有的数据目录及其内容复制到新文件夹中。请注意，您只复制数据，而不是整个 MySQL 安装，这是不必要的:

```py
$ sudo cp -R /usr/local/mysql/data  /media/mysql/mysql_data
$ chown -R mysql mysql /media/mysql/mysql_data

```

Note

如果出现权限错误，请尝试将`/media/mysql`文件夹的所有者更改为`mysql:mysql`。

接下来，编辑 MySQL 的配置文件。在这种情况下，您将`datadir`行改为`datadir = /media/mysql`。注释掉 bind-address 行以允许从网络上的其他系统访问 MySQL 也是一个好主意:

```py
$ sudo vi /etc/mysql/my.cnf

```

还有最后一步。您必须将所有者和组更改为安装时创建的 MySQL 用户。以下是正确的命令:

```py
$ sudo chown -R mysql:mysql /media/mysql/mysql_data

```

现在您重新启动 MySQL:

```py
$ sudo systemctl start mysql

```

您可以通过连接到 MySQL，创建一个新的数据库，然后检查新文件夹是否是在外部驱动器上创建的，来确定这些更改是否有效，如清单 [8-10](#PC39) 所示。

```py
$ ./bin/mysql -uroot -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 9
Server version: 8.0.18 Source distribution

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> SHOW VARIABLES LIKE 'datadir';
+---------------+----------------------------------+
| Variable_name | Value                            |
+---------------+----------------------------------+
| datadir       | /media/pi/mysql/mysql_data/data/ |
+---------------+----------------------------------+
1 row in set (0.08 sec)

mysql> CREATE DATABASE testme;
Query OK, 1 row affected (0.08 sec)

mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| testme             |
+--------------------+
5 rows in set (0.06 sec)

mysql> \q
Bye
pi@raspberrypi:/usr/local/mysql $ sudo ls -lsa /media/pi/mysql/mysql_data/data
total 168024
    4 drwxr-x--- 7 mysql mysql     4096 Nov 27 15:09  .
    4 drwxr-xr-x 3 mysql mysql     4096 Nov 27 15:03  ..
    4 -rw-r----- 1 mysql mysql       56 Nov 27 15:03  auto.cnf
    4 -rw-r----- 1 mysql mysql      499 Nov 27 15:03  binlog.000001
    4 -rw-r----- 1 mysql mysql      178 Nov 27 15:03  binlog.000002
    4 -rw-r----- 1 mysql mysql      346 Nov 27 15:09  binlog.000003
    4 -rw-r----- 1 mysql mysql       48 Nov 27 15:06  binlog.index
...
    4 -rw-r----- 1 mysql mysql     3344 Nov 27 15:03  ib_buffer_pool
12288 -rw-r----- 1 mysql mysql 12582912 Nov 27 15:09  ibdata1
49152 -rw-r----- 1 mysql mysql 50331648 Nov 27 15:09  ib_logfile0
49152 -rw-r----- 1 mysql mysql 50331648 Nov 27 15:03  ib_logfile1
12288 -rw-r----- 1 mysql mysql 12582912 Nov 27 15:06  ibtmp1
...
    4 drwxr-x--- 2 mysql mysql     4096 Nov 27 15:09  testme

Listing 8-10Testing the New Data Directory

```

在输出中，新的数据库名称表示为文件夹`testme`。

现在，你有了它——一个运行在 Raspberry Pi 上的新的 MySQL 数据库服务器！

如果您想知道新的数据库服务器还能做些什么，请继续阅读。在下一节中，您将处理 MySQL 中一个非常流行的特性，称为复制。它允许两台或多台服务器拥有数据库的副本。出于您的目的，使用副本作为备份可能会很方便，所以您不必从您的 Raspberry Pi 手动复制任何文件。

### 高级项目:使用 MySQL 复制来备份您的传感器数据

使用外部驱动器保存 MySQL 数据的最大好处之一是，您可以随时关闭服务器，断开驱动器，将其插入另一个系统，然后复制数据。如果您的 Raspberry Pi 数据库服务器位于一个(物理上)容易到达的位置，并且有时可以关闭服务器，那么这听起来可能很棒。

然而，对于一些传感器网络来说，情况可能并非如此。将 Raspberry Pi 用于数据库服务器的一个好处是，服务器可以位于传感器节点附近。如果传感器网络位于隔离区域，您可以通过将 Raspberry Pi 放在相同的位置来收集和存储数据。但是，如果没有网络连接到数据库服务器，这可能意味着要跋涉到一个谷仓或池塘，或者步行几个足球场的长度到一个工厂的内部去得到硬件。

但是，如果您的 Raspberry Pi 连接到网络，您可以使用 MySQL 的一项名为复制的高级功能来制作数据的实时最新副本。这不仅意味着您可以有一个备份，还意味着您可以查询维护副本的服务器，从而减轻您的 Raspberry Pi 的复杂或长时间运行的查询负担。Raspberry Pi 是一台非常酷的小尺寸计算机，但它不是数据仓库。

#### 什么是复制，它是如何工作的？

MySQL 复制是一个易于使用的特性，同时也是 MySQL 服务器的一个非常复杂的主要组件。本节提供了复制的鸟瞰图，目的是解释它是如何工作的以及如何设置一个简单的复制拓扑。有关复制及其众多特性和命令的更多信息，请参见在线 MySQL 参考手册( [`http://dev.mysql.com/doc/refman/5.5/en/replication.html`](http://dev.mysql.com/doc/refman/5.5/en/replication.html) )。

复制需要两台或更多服务器。必须将一台服务器指定为源服务器或主服务器。主角色意味着对数据的所有数据更改(写入)都发送到主服务器，并且只发送到主服务器。拓扑中的所有其他服务器维护主数据的副本，并且根据设计和要求是只读服务器。因此，当您的传感器发送数据进行存储时，它们会将数据发送给主设备。您编写的使用传感器数据的应用程序可以从从属服务器读取这些数据。

复制机制使用一种称为二进制日志的技术，该技术以一种特殊的格式存储更改，从而保留所有更改的记录。这些更改然后被运送到从设备，并在那里重新执行。因此，一旦从机重新执行更改(称为事件)，从机就拥有了数据的精确副本。

主服务器维护更改的二进制日志，从服务器维护该二进制日志的副本，称为中继日志。当从设备向主设备请求数据更改时，它从主设备读取事件并将它们写入其中继日志；然后，从属线程中的另一个线程执行中继日志中的那些事件。可以想象，从主服务器上发生更改到从服务器上发生更改会有一点延迟。幸运的是，这种延迟几乎是不明显的，除非是在流量非常大的拓扑结构中(有很多变化)。出于您的目的，当您从从属服务器读取数据时，它可能是最新的。您可以使用命令`SHOW SLAVE STATUS`检查从设备的进度；在许多其他事情中，它向你显示了奴隶落后于主人有多远。您将在后面的小节中看到这个命令的运行。

现在您已经对复制及其工作原理有了一些了解，让我们来看看如何设置它。下一节将讨论如何将 Raspberry Pi 设置为主机，将桌面计算机设置为从机。

#### 如何设置复制

本节演示如何设置从 Raspberry Pi(主)到桌面计算机(从)的复制。这些步骤包括通过启用二进制日志记录和创建用于读取二进制日志的用户帐户来准备主服务器，通过将从服务器连接到主服务器来准备从服务器，以及启动从服务器进程。最后，对复制系统进行测试。

##### 准备母版

复制要求主服务器启用二进制日志记录。默认情况下它是不打开的，因此您必须编辑配置文件并将其打开。使用`sudo vi /etc/mysql/my.cnf`编辑配置文件，并通过取消注释和更改以下行来打开二进制日志记录:

```py
server-id = 1
log_bin = /media/mysql/mysql_data/mysql-bin.log

```

第一行设置主服务器的服务器 ID。在基本复制(5.5 版)中，每台服务器必须有一个唯一的服务器 ID。在这种情况下，您将 1 分配给主服务器；从机将具有一些其他值，例如 2。富有想象力，是吗？

下一行设置二进制日志文件的位置和名称。您将它保存到您的外部驱动器，因为像数据本身一样，二进制日志会随着时间的推移而增长。幸运的是，MySQL 旨在将文件保持在一个合理的大小，并具有允许您截断它并开始一个新文件的命令(这一过程称为旋转)。有关管理二进制日志文件的更多信息，请参见在线参考手册( [`https://dev.mysql.com/doc/refman/8.0/en/replication.html`](https://dev.mysql.com/doc/refman/8.0/en/replication.html) )。一旦保存了编辑，您就可以重启 MySQL 服务器(或者简单地停止然后启动)。

接下来，您必须创建一个用户，供从服务器用来连接到主服务器并读取二进制日志。这个有一个特殊的特权叫做`REPLICATION SLAVE`。下面的代码显示了创建用户和添加权限的正确的`GRANT`语句。记住您在这里使用的用户名和密码—您需要它用于从属服务器:

```py
mysql> CREATE USER 'rpl'@'%' IDENTIFIED BY 'secret'
Query OK, 0 rows affected (0.01 sec)
mysql> GRANT REPLICATION SLAVE ON ∗.∗ TO 'rpl'@'%';
Query OK, 0 rows affected (0.01 sec)

```

但是从机还需要一条信息。从机需要知道要读取的二进制日志的名称，以及从文件中的什么位置开始读取事件。您可以使用`SHOW MASTER STATUS`命令来确定这一点:

```py
mysql> SHOW MASTER STATUS;
+--------------+----------+-------------+------------------+...
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB |...
+--------------+----------+-------------+------------------+...
| binlog.000003 |      878 |              |                  |...
+--------------+----------+-------------+------------------+...
1 row in set (0.00 sec)

```

现在您已经有了主服务器的二进制日志文件名和位置以及复制用户和密码，您可以访问您的从服务器并将其连接到主服务器。您还需要知道 Raspberry Pi 的主机名或 IP 地址，以及 MySQL 运行的端口。默认情况下，端口是 3306；但是如果你改变了它，你应该注意到新的值。记下表 [8-1](#Tab1) 中的所有信息。

表 8-1

复制所需的主服务器信息

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

主文件中的项目

 | 

价值

 |
| --- | --- |
| IP 地址或主机名 |   |
| 港口 |   |
| 二进制日志文件 |   |
| 二进制日志文件位置 |   |
| 复制用户 ID |   |
| 复制用户密码 |   |

您想要用作从属服务器的 MySQL 服务器应该与 Raspberry Pi 上的服务器版本相同，或者至少是兼容的服务器。在线参考手册指定了哪些 MySQL 版本可以很好地协同工作。幸运的是，有问题的版本列表非常短。在本节中，您应该在台式机或服务器计算机上安装一台服务器，并确保其配置正确。

将从设备连接到主设备所需的步骤包括发出一个`CHANGE MASTER`命令来连接到主设备，以及发出一个`START SLAVE`命令来启动服务器上的从设备角色。是的，就是这么简单！回想一下，您需要来自主机的信息来完成这些命令。以下命令显示了一个从设备连接到一个运行在 Raspberry Pi 上的主设备。让我们从如下所示的`CHANGE MASTER`命令开始:

```py
mysql> CHANGE MASTER TO MASTER_HOST='10.0.1.17', MASTER_PORT=3306, MASTER_LOG_FILE='mysql-bin.000003', MASTER_LOG_POS=878, MASTER_USER="rpl", MASTER_PASSWORD="secret";
Query OK, 0 rows affected (0.22 sec)

```

这个例子使用了 Raspberry Pi 的 IP 地址、端口号(默认为 3306)、来自`SHOW MASTER STATUS`命令的日志文件和位置，以及复制用户的用户和密码。如果您键入的命令正确，它应该会无错误地返回。如果有错误或警告，使用`SHOW WARNINGS`命令读取警告并纠正任何问题。

下一步是启动从属进程。这个命令简单来说就是`START SLAVE`。它通常不会报告任何错误；您必须使用`SHOW SLAVE STATUS`才能看到它们。清单 [8-11](#PC44) 显示了这两个命令的运行情况。

Tip

对于宽结果，使用`\G`选项将列视为行(称为垂直格式)。

```py
mysql> start slave;
Query OK, 0 rows affected (0.00 sec)

mysql> show slave status \G
∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗ 1\. row ∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗∗
       Slave_IO_State: Waiting for master to send event
  Master_Host: 10.0.1.17
  Master_User: rpl
  Master_Port: 3306
Connect_Retry: 60
      Master_Log_File: mysql-bin.000003
  Read_Master_Log_Pos: 107
       Relay_Log_File: clone-relay-bin.000003
Relay_Log_Pos: 4
Relay_Master_Log_File: mysql-bin.000001
     Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
      Replicate_Do_DB:
  Replicate_Ignore_DB:
   Replicate_Do_Table:
       Replicate_Ignore_Table:
      Replicate_Wild_Do_Table:
  Replicate_Wild_Ignore_Table:
   Last_Errno: 0
   Last_Error:
 Skip_Counter: 0
  Exec_Master_Log_Pos: 107
      Relay_Log_Space: 555
      Until_Condition: None
       Until_Log_File:
Until_Log_Pos: 0
   Master_SSL_Allowed: No
   Master_SSL_CA_File:
   Master_SSL_CA_Path:
      Master_SSL_Cert:
    Master_SSL_Cipher:
       Master_SSL_Key:
Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
Last_IO_Errno: 0
Last_IO_Error:
       Last_SQL_Errno: 0
       Last_SQL_Error:
  Replicate_Ignore_Server_Ids:
     Master_Server_Id: 1
1 row in set (0.00 sec)

mysql>

Listing 8-11Starting the Slave

```

花点时间费力地读完所有这些行。有几个关键字段你需要注意。这些错误包括名称和状态列中的任何错误。例如，第一行(`Slave_IO_State`)显示了指示从机 I/O 线程状态的文本消息。I/O 线程负责从主服务器的二进制日志中读取事件。还有一个 SQL 线程负责从中继日志中读取事件并执行它们。

对于这个例子，您只需要确保两个线程都在运行(`YES`)并且没有错误。关于`SHOW SLAVE STATUS`命令中所有字段的详细解释，请参见在线 MySQL 参考手册( [`https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html) )。

既然从属服务器已经连接并正在运行，让我们检查它上面的`testme`数据库:

```py
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.00 sec)

mysql>

```

等等！它去哪里了？这个例子不是应该复制一切吗？嗯，是也不是。的确，你的奴隶与主人相连，从现在开始，它将复制主人身上发生的任何变化。回想一下，您使用了`SHOW MASTER STATUS`命令来获取二进制日志文件和位置。这些值是下一个事件位置的坐标，而不是任何先前事件的坐标。啊哈:您在创建了`testme`数据库之后设置了复制。

你怎么解决这个问题？那得看情况。如果您真的想要复制`testme`数据库，您必须停止复制，修复主数据库，然后重新连接从数据库。我不会详细介绍这些步骤，但是我在这里列出了它们作为您自己试验的大纲:

1.  阻止奴隶。

2.  转到主服务器并删除数据库。

3.  获取新的`SHOW MASTER STATUS`数据。

4.  重新连接从机。

5.  启动从机。

明白了吗？很好。如果没有，这是一个很好的练习，回去自己尝试这些步骤。

清理主服务器并重启复制后，继续尝试在主服务器上创建一个数据库，并观察从服务器上的结果。以下是命令。我使用了不同的数据库名称，以防您选择不尝试前面的挑战，如下所示:

```py
mysql> create database testme_again;
Query OK, 1 row affected (0.00 sec)

mysql> show databases;
+--------------------+
| Database          |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| testme             |
| testme_again       |
+--------------------+
4 rows in set (0.01 sec)

mysql>

```

返回到从属数据库，查看其中列出了哪些数据库，如下所示:

```py
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| testme_again       |
+--------------------+
4 rows in set (0.00 sec)

mysql>

```

成功！现在，您的 Raspberry Pi 数据库服务器正在由您的桌面计算机进行备份。

## 部件购物清单

本章唯一需要的新组件是一个多余的 USB 硬盘，列于表 [8-2](#Tab2) 中。表 [8-3](#Tab3) 显示了包含在其他章节购物清单中的支持硬件列表。

表 8-3

以前章节中重复使用的组件

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

项目

 | 

供应商

 | 

是吗？成本美元

 | 

所需数量

 |
| --- | --- | --- | --- |
| Raspberry Pi 型号 4B 2GB 或 4GB 内存 | sparkfun . com、adafruit.com、thepithut.com | 50 美元以上 | one |
| 迷你 HDMI 电缆 | 大多数在线和零售商店 | 变化 | one |
| HDMI 或 DVI 监视器 | 大多数在线和零售商店 | 变化 | one |
| USB 键盘 | 大多数在线和零售商店 | 变化 | one |
| USB-C 电源 | 大多数在线和零售商店 | 变化 | one |
| SD 卡，32GB 或更大 | 大多数在线和零售商店 | 变化 | one |

表 8-2

所需组件

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"> <col class="tcol3 align-left"> <col class="tcol4 align-left"></colgroup> 
| 

项目

 | 

供应商

 | 

是吗？成本美元

 | 

所需数量

 |
| --- | --- | --- | --- |
| 剩余硬盘 | 任何 USB 硬盘(多余的或购买的) | 变化 | one |

## 摘要

这一章介绍了 MySQL，并给了你一个如何使用它的速成班。您还在 Raspberry Pi 上编译并安装了 MySQL，并了解了如何使用 MySQL 的更多高级特性，比如复制。

虽然它没有高可用性、五个九正常运行时间(99.999%)数据库服务器那么复杂，但带有附加 USB 硬盘驱动器的低成本 Raspberry Pi 是一个占用空间非常小的数据库服务器，可以放在任何地方。

这一点非常重要，因为传感器网络天生就需要体积小、成本低。必须构建一个昂贵的数据库服务器通常不是所期望的投资水平。

此外，根据您为传感器选择的主机，保存数据很困难。如果您选择 Arduino 作为主机，将数据存储到数据库需要连接到互联网，并依赖另一个服务来存储您的数据。这对于实际上可以将传感器节点连接到互联网 <sup>[12](#Fn12)</sup> (或传感器网络的聚合器节点)的情况来说是很好的；但是如果你不能或者不想连接到互联网，从 Arduino 获取数据到数据库服务器是很困难的。

也就是说，直到最近。正如您将看到的，确实有一种方法可以保存来自传感器节点的传感器数据。在下一章中，您将构建一个传感器节点，它将数据保存在新的数据库服务器中——直接从 Arduino！

<aside aria-label="Footnotes" class="FootnoteSection" epub:type="footnotes">Footnotes [1](#Fn1_source)

请注意，在撰写本文时，Raspberry Pi(使用 ARM 架构，而不是 x86 或 SPARC)还不是 MySQL 支持的平台——但是您可以让它工作起来！

  [2](#Fn2_source)

根据 GNU ( [`www.gnu.org/philosophy/free-sw.html`](http://www.gnu.org/philosophy/free-sw.html) )，“自由软件是自由的问题，不是价格的问题。要理解这个概念，你应该把‘免费’理解为‘言论自由’，而不是‘免费啤酒’。”

  [3](#Fn3_source)

并在 Windows 系统上使用`--console`命令行选项。

  [4](#Fn4_source)

C.数据库关系模型:回顾和分析。

  [5](#Fn5_source)

C.J. Date 和 H. Darwen，*未来数据库系统的基础:第三宣言*(阅读，MA: Addison-Wesley，2000)。

  [6](#Fn6_source)

如果你想了解更多关于存储引擎的知识，以及是什么让它们运转起来，请参阅我的书《专家 MySQL 第二版》。

  [7](#Fn7_source)

[T2`http://en.wikipedia.org/wiki/ACID`](http://en.wikipedia.org/wiki/ACID)

  [8](#Fn8_source)

虽然大多数传感器节点只写数据，但是一些传感器数据可能需要与其他已知数据结合(通过查找表)才是相关的。

  [9](#Fn9_source)

vi 是什么意思？如果您曾经有幸第一次尝试学习它，您可能会认为它意味着“几乎不可能”，因为命令很简洁(根据设计)，很难记住。不过说真的，vi 是 vim 或者 Vi 改进文本编辑器的简称。顾名思义，最初的编辑器很可能已经完全不可能使用了！

  [10](#Fn10_source)

MySQL 的旧版本可以用于 Raspberry Pi，但是要小心！其中一些版本不是由 Oracle 发布或维护的。强烈推荐使用 Oracle 当前发布的 MySQL，即使它需要更多的工作才能在 Raspberry Pi 上运行。

  [11](#Fn11_source)

虽然您可以创建一个更大的交换文件来进行补偿，但是由于与磁盘交换的性能较低，使用大交换文件进行编译可能需要 12 个多小时才能完成。

  [12](#Fn12_source)

将传感器节点连接到互联网是物联网(IoT)的组成部分之一。

 </aside>