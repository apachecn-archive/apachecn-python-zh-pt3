# 十九、有趣的编程

此时，您应该对 Python 的工作原理有了比开始时更清晰的了解。可以说，现在橡胶上路了，在接下来的十章中，你将把你的新技能投入到工作中。每章包含一个自己动手的项目，有很大的实验空间，同时给你必要的工具来实现一个解决方案。

在这一章，我给你一些用 Python 编程的通用指南。

## 为什么好玩？

我认为 Python 的优势之一是它让编程变得有趣——至少对我来说是这样。当你玩得开心的时候，更容易富有成效；Python 的一个有趣之处是它让你变得非常有效率。这是一个积极的反馈循环，你在生活中得到的太少了。

戏谑编程是我发明的一个不太极端的极端编程版本，简称 XP。我喜欢 XP 运动的许多想法，但一直懒得完全遵守它们的原则。相反，我选择了一些东西，并将它们与我认为是用 Python 开发程序的一种自然方式结合起来。

## 编程的柔术

你可能听说过柔术？这是一种日本武术，像它的后代柔道和合气道一样， [<sup>2</sup>](#Fn2) 专注于反应的灵活性，或“弯曲而不是打破”不要试图把你预先计划好的动作强加给对手，你要随波逐流，用对手的动作来对付他。这样(理论上)你就可以打败比你更大、更卑鄙、更强的对手。

这如何应用于编程？关键是音节“ju”，它可以(非常粗略地)翻译为灵活性。当你在编程中遇到麻烦时(你总是会遇到)，不要僵硬地坚持你最初的设计和想法，要灵活。逆来顺受。准备好改变和适应。不要把不可预见的事件视为令人沮丧的干扰；将它们视为创造性探索新选择和可能性的刺激起点。

关键是，当你坐下来计划你的程序应该如何时，你对那个特定的程序没有任何实际的经验。你怎么能这样？毕竟现在还不存在。通过致力于实现，您会逐渐学到新的东西，这些东西在您进行最初的设计时可能是有用的。不要忽视你在这个过程中获得的经验，你应该用它们来重新设计(或重构)你的软件。我并不是说你应该在不知道你要去哪里的情况下就开始动手，而是说你应该为改变做好准备，并接受你最初的设计需要修改。就像老作家说的:“写作就是改写。”

这种灵活性的实践有许多方面；在这里，我将谈到其中的两个:

*   原型:Python 的一个好处是可以快速编写程序。写一个原型程序是了解你的问题的一个很好的方法。
*   配置:灵活性有多种形式。配置的目的是为了让您和您的用户更容易地更改程序的某些部分。

第三个方面，自动化测试，如果你想能够容易地改变你的程序，是绝对必要的。有了测试，你就可以确定你的程序在引入修改后仍然工作。原型和配置将在下面的章节中讨论。有关测试的信息，请参见第 [16 章](16.html)。

## 样机研究

总的来说，如果你想知道 Python 中的一些东西是如何工作的，那就试试吧。你不需要做大量的预处理，比如编译或者链接，这在其他语言中是必须的。你可以直接运行你的代码。不仅如此，你还可以在交互式解释器中一点一点地运行它，直到你完全理解它的行为。

这种探索不仅仅涉及语言特性和内置函数。当然，能够准确地找出`iter`函数是如何工作的是有用的，但是更重要的是能够轻松地创建您将要编写的程序的原型，只是为了看看它是如何工作的。

Note

在这个上下文中，单词 prototype 意味着一个试验性的实现，一个实现最终程序的主要功能的模型，但是可能需要在以后的某个阶段完全重写，或者不重写。通常，最初的原型可以变成一个工作程序。

在您对程序的结构进行了一些思考之后(比如您需要哪些类和函数)，我建议实现一个简单的版本，可能功能非常有限。你会很快注意到，当你有一个正在运行的程序时，这个过程变得简单多了。你可以添加功能，改变你不喜欢的东西，等等。你可以真正看到它是如何工作的，而不只是想想或者在纸上画图表。

您可以在任何编程语言中使用原型，但是 Python 的优势在于编写一个模型是一项非常小的投资，所以您不一定要使用它。如果你发现你的设计没有想象中的聪明，你可以简单地扔掉你的原型，从头开始。这个过程可能需要几个小时或一两天。举例来说，如果你用 C++编程，可能需要做更多的工作来启动和运行一些东西，放弃它将是一个重大的决定。通过提交一个版本，你失去了灵活性；你会被早期的决定所束缚，根据你实际执行的经验，这些决定可能是错误的。

在本章后面的项目中，我一直使用原型而不是预先的详细分析和设计。每个项目都分为两个实现。第一个是摸索性实验，在这个实验中，我拼凑了一个解决问题(或者可能只是问题的一部分)的程序，以便了解一个好的解决方案所需的组件和要求。最大的教训可能是看到程序运行中的所有缺陷。通过建立在这个新发现的知识上，我采取了另一个，希望是更明智的，打击它。当然，你可以随意修改代码，甚至第三次从头开始。通常，从零开始并不像你想象的那样需要太多时间。如果你已经考虑过程序的实用性，打字不会花太长时间。

The Case Against Rewriting

虽然我在这里提倡使用原型，但是在任何时候都有理由对从零开始重新启动项目持谨慎态度，尤其是如果您已经在原型上投入了一些时间和精力。出于几个原因，将原型重构并修改成一个更具功能性的系统可能更好。

一个常见的问题是“第二系统综合症”这是试图让第二个版本变得如此聪明或完美的趋势，以至于它永远不会完成。

“持续重写综合症”在小说写作中非常普遍，它倾向于不断修改你的程序，也许是一次又一次地从头开始。在某些时候，保持足够好的状态可能是最好的策略——只要得到有用的东西。

然后是“代码疲劳”。你厌倦了你的代码。当你使用它很长时间后，你会觉得它又丑又笨。可悲的是，它看起来粗糙和笨拙的原因之一是，它已经适应了一系列特殊情况，并合并了几种形式的错误处理等。无论如何，这些都是您需要在新版本中重新引入的特性，并且它们可能已经花费了您相当多的精力(不仅仅是以调试的形式)来实现。

换句话说，如果你认为你的原型可以变成一个可行的系统，无论如何，继续研究它，而不是重新开始。在接下来的项目章节中，我将开发清晰地分为两个版本:原型和最终程序。这部分是为了清晰，部分是为了突出通过编写一个软件的第一个版本可以获得的经验和洞察力。在现实世界中，我很可能从原型开始，朝着最终系统的方向“重构自己”。

想了解更多关于从头开始的恐惧，看看乔尔·斯波尔斯基的文章《你不该做的事，第一部分》(见他的网站， [`http://joelonsoftware.com`](http://joelonsoftware.com) )。斯波尔斯基认为，从头重写代码是任何软件公司都会犯的最严重的战略错误。

## 配置

在这一节中，我将回到非常重要的抽象原则。在第 [6](06.html) 和 [7](07.html) 章中，我向你展示了如何通过将代码放入函数和方法中并在类中隐藏更大的结构来提取代码。让我们来看看在程序中引入抽象的另一种更简单的方式:从代码中提取符号常量。

### 提取常数

我所说的常量是指内置的文字值，比如数字、字符串和列表。您可以将它们收集在全局变量中，而不是在程序中重复编写它们。我知道我已经警告过你了，但是全局变量的问题主要发生在你开始改变它们的时候，因为很难跟踪你的代码的哪个部分负责哪个改变。然而，我不去管这些变量，而是把它们当作常量来使用(因此有了符号常量这个术语)。为了表示一个变量将被视为一个符号常量，您可以使用一个特殊的命名约定，在变量名中只使用大写字母，并用下划线分隔单词。

我们来看一个例子。在一个计算圆的面积和周长的程序中，每次需要π值时，你可以一直写 3.14。但是，如果您稍后想要一个更精确的值，比如 3.14159，该怎么办呢？您需要搜索整个代码并用新值替换旧值。这并不难，在大多数优秀的文本编辑器中，这可以自动完成。然而，如果你从值 3 开始呢？您是否希望以后用 3.14159 替换所有出现的数字 3？几乎没有。一个更好的处理方法是用行`PI = 3.14`开始程序，然后用名字`PI`代替数字本身。这样，您可以简单地修改这一行，在以后的某个时间获得更精确的值。只要记住这一点:每当你写一个常数(比如数字 42 或字符串“Hello，world！”)多次，请考虑将其放入全局变量中。

Note

实际上，π的值是在数学模块中找到的，名为`math.pi`:

```py
>>> from math import pi
>>> pi
3.1415926535897931

```

这对你来说似乎是显而易见的。但是所有这些的真正意义在下一节，我将讨论配置文件。

### 配置文件

为了自己的利益提取常量是一回事，但是有些常量甚至可以暴露给用户。例如，如果他们不喜欢你的 GUI 程序的背景颜色，也许你应该让他们使用另一种颜色。或者，也许您可以让用户决定当他们启动您激动人心的街机游戏或您刚刚实现的新 web 浏览器的默认起始页时，他们希望收到什么样的问候消息。

您可以将这些配置变量放在一个单独的文件中，而不是放在一个模块的顶部。最简单的方法是用一个单独的模块进行配置。例如，如果在模块文件`config.py`中设置了`PI`，您可以(在主程序中)执行以下操作:

```py
from config import PI

```

然后，如果用户想要不同的值给`PI`，她可以简单地编辑`config.py`，而不必费力地通过你的代码。

Caution

使用配置文件是有代价的。一方面，配置是有用的，但是为整个项目使用一个集中的、共享的变量存储库会使它变得不那么模块化，更加单一。确保你没有破坏抽象(比如封装)。

另一种可能是使用标准库模块`configparser`，这将允许您使用合理的标准格式来配置文件。它允许两种标准的 Python 赋值语法，例如:

```py
greeting = 'Hello, world!'

```

(尽管这会在字符串中给你两个无关的引号)和许多程序中使用的另一种配置格式:

```py
greeting: Hello, world!

```

您必须使用像`[files]`或`[colors]`这样的头文件将配置文件分成几个部分。名称可以是任何东西，但是需要用括号括起来。清单 [19-1](#Par42) 显示了一个示例配置文件，清单 [19-2](#Par43) 显示了一个使用它的程序。有关`configparser`模块特性的更多信息，请参考库文档。

```py
[numbers]

pi: 3.1415926535897931

[messages]

greeting: Welcome to the area calculation program!
question: Please enter the radius:
result_message: The area is

Listing 19-1.A Simple Configuration File

```

```py
from configparser import ConfigParser

CONFIGFILE = "area.ini"

config = ConfigParser()
# Read the configuration file:
config.read(CONFIGFILE)

# Print out an initial greeting;
# 'messages' is the section to look in:
print(config['messages'].get('greeting'))

# Read in the radius, using a question from the config file:
radius = float(input(config['messages'].get('question') + ' '))

# Print a result message from the config file;
# end with a space to stay on same line:
print(config['messages'].get('result_message'), end=' ')

# getfloat() converts the config value to a float:
print(config['numbers'].getfloat('pi') * radius**2)

Listing 19-2.A Program Using ConfigParser

```

在接下来的项目中，我不会详细讨论配置，但是我建议你考虑让你的程序可配置。这样，用户就可以根据自己的喜好来调整程序，从而使使用程序变得更加愉快。毕竟，使用软件的主要挫折之一是你不能让它按照你想要的方式运行。

Levels of Configuration

可配置性是 UNIX 编程传统中不可或缺的一部分。在他的优秀著作《UNIX 编程的艺术》( Addison-Wesley，2003)的第 [10](10.html) 章中，Eric S. Raymond 描述了配置或控制信息的以下三个来源，这些信息(如果包括的话)可能应该按照以下顺序查阅[T3】3T5】以便后面的来源覆盖前面的来源:](#Fn3)

*   配置文件:请参阅本章中的“配置文件”一节。
*   环境变量:可以使用字典`os.environ`获取这些变量。
*   命令行传递给程序的开关和参数:对于处理命令行参数，可以直接使用`sys.argv`。如果你想处理开关(选项)，你应该检查一下`argparse`模块，正如第 [10 章](10.html)中提到的。

## 记录

与测试有点关系(在第 [16 章](16.html)中讨论),并且在疯狂地修改程序内部时非常有用，日志当然可以帮助你发现问题和错误。日志记录基本上是在程序运行时收集有关程序的数据，这样您就可以在以后检查它(或者在数据积累时检查它)。一种非常简单的日志形式可以用`print`语句来完成。只要在你的程序的开头加上这样一句话:

```py
log = open('logfile.txt', 'w')

```

然后，您可以将有关程序状态的任何有趣信息放入该文件，如下所示:

```py
print('Downloading file from URL', url, file=log)
text = urllib.urlopen(url).read()
print'File successfully downloaded', file=log)

```

如果你的程序在下载过程中崩溃了，这种方法就不好用了。如果您为每个`log`语句打开和关闭您的文件(或者，至少在写入后刷新文件)会更安全。然后，如果你的程序崩溃了，你可以看到日志文件的最后一行写着“从 URL 下载文件”,你就知道下载没有成功。

实际上，应该使用标准库中的`logging`模块。基本用法非常简单，如清单 [19-3](#Par56) 中的程序所示。

```py
import logging

logging.basicConfig(level=logging.INFO, filename='mylog.log')

logging.info('Starting program')

logging.info('Trying to divide 1 by 0')

print(1 / 0)

logging.info('The division succeeded')

logging.info('Ending program')

Listing 19-3.A Program Using the logging Module

```

运行该程序会产生以下日志文件(名为`mylog.log`):

```py
INFO:root:Starting program
INFO:root:Trying to divide 1 by 0

```

如您所见，在尝试将 1 除以 0 之后，没有记录任何内容，因为这个错误实际上会杀死程序。因为这是一个如此简单的错误，所以您可以通过程序崩溃时打印的异常回溯来判断出问题所在。最难追踪的错误类型是不会停止你的程序，而只是让它行为异常的那种。检查详细的日志文件可能有助于您了解发生了什么。

这个例子中的日志文件不是很详细，但是通过正确地配置`logging`模块，您可以设置您想要的日志工作方式。这里有几个例子:

*   不同类型的日志条目(信息、调试信息、警告、自定义类型等)。默认情况下，只允许警告通过(这就是为什么我在清单 [19-3](#Par56) 中将级别显式设置为`logging.INFO`)。
*   只记录与程序的某些部分相关的项目。
*   记录时间、日期等信息。
*   记录到不同的位置，例如套接字。
*   配置记录器以过滤掉部分或大部分日志记录，这样您就可以在任何时候只获得您需要的内容，而无需重写程序。

模块相当复杂，文档中有很多东西需要学习。

## 如果你不想被打扰

“这一切都很好，”你可能会想，“但是我不可能花那么多精力去写一个简单的小程序。配置、测试、记录——听起来真的很无聊。”

嗯，那很好。简单的程序可能不需要它。即使你正在做一个更大的项目，在开始的时候你可能真的不需要所有这些。我认为最起码你有一些测试程序的方法(如第 [16](16.html) 章所讨论的)，即使它不是基于自动单元测试。例如，如果你正在编写一个自动为你煮咖啡的程序，你应该准备一个咖啡壶，看看它是否工作。

在接下来的项目章节中，我不会编写完整的测试套件、复杂的日志记录设施等等。我向您展示一些简单的测试案例来演示程序的工作原理，仅此而已。如果你发现一个项目的核心思想很有趣，你应该更进一步——尝试增强和扩展它。在这个过程中，你应该考虑你在本章读到的问题。也许配置机制是个好主意？或者更广泛的测试套件？这取决于你。

## 如果你想了解更多

如果你想了解更多关于编程的艺术、技巧和哲学的信息，这里有一些更深入讨论这些内容的书籍:

*   《实用程序员》,作者:安德鲁·亨特和戴维·托马斯
*   《重构》，肯特·贝克等人著(艾迪森-韦斯利，1999 年)
*   设计模式，由“四人帮”埃里希·伽马、理查德·赫尔姆、拉尔夫·约翰逊、约翰·弗利塞德斯(Addison-Wesley，1994)提出
*   《测试驱动的开发:以实例为例》,作者肯特·贝克
*   《UNIX 编程的艺术》，作者 Eric S. Raymond (Addison-Wesley，2003)[<sup>4</sup>T3】](#Fn4)
*   《算法导论》，第二版，托马斯·h·科尔曼等著(麻省理工学院出版社，2001 年)
*   《计算机编程的艺术》,第 1-3 卷，作者唐纳德·克努特(爱迪生韦斯利公司，1998 年)
*   《计算机编程的概念、技术和模型》，Peter Van Roy 和 Seif Haridi 著(麻省理工学院出版社，2004 年)

即使你没有读完每本书的每一页(我知道我没有)，只要浏览其中的几页就能给你带来相当多的洞察力。

## 快速总结

在这一章中，我描述了一些用 Python 编程的一般原则和技术，方便地集中在标题“有趣的编程”下以下是亮点:

*   灵活性:在设计和编程时，你应该以灵活性为目标。不要坚持你最初的想法，你应该愿意——甚至准备好——随着你对手头问题的深入了解，修改和改变你程序的每一个方面。
*   原型:学习一个问题和可能的实现的一个重要技术是写一个简单版本的程序来看看它是如何工作的。在 Python 中，这是如此简单，以至于你可以在用许多其他语言编写一个版本的时间内编写几个原型。不过，如果没有必要的话，你应该警惕重写代码——重构通常是更好的解决方案。
*   配置:从你的程序中提取常量，使得在以后的某个时候修改它们变得更加容易。将它们放在一个配置文件中，可以让你的用户按照他们的意愿配置程序。使用环境变量和命令行选项可以使您的程序更加可配置。
*   日志记录:日志记录对于发现程序中的问题非常有用——或者仅仅是监视它的普通行为。您可以使用`print`语句自己实现简单的日志记录，但是最安全的做法是使用标准库中的`logging`模块。

### 什么现在？

的确，现在怎么办？现在是冒险真正开始编程的时候了。项目时间到了。所有十个项目章节都有类似的结构，包括以下部分:

*   “有什么问题？”:在本节中，概述了项目的主要目标，包括一些背景信息。
*   “有用的工具”:在这里，我描述了可能对项目有用的模块、类、函数等等。
*   “准备工作”:本节涵盖开始编程前的任何必要准备工作。这可能包括为测试实现建立必要的框架。
*   “第一次实现”:这是第一次尝试——一次尝试性的实现，以了解问题的更多信息。
*   “第二次实现”:在第一次实现之后，你大概会对事物有更好的理解，这将使你能够创建一个新的改进版本。
*   “进一步探索”:最后，我给出进一步实验和探索的指针。让我们从第一个项目开始，这是创建一个自动用 HTML 标记文件的程序。

Footnotes [1](#Fn1_source)

极限编程是一种软件开发方法，可以说已经被程序员使用了很多年，但它是由 Kent Beck 首先命名和记录的。更多信息请参见 [`http://www.extremeprogramming.org`](http://www.extremeprogramming.org) 。

  [2](#Fn2_source)

或者，就此而言，它的中国亲戚，如太极拳或八卦掌。

  [3](#Fn3_source)

实际上，全局配置文件和系统设置的环境变量在这些之前。更多细节见书。

  [4](#Fn4_source)

也可以在 Raymond 的网站上在线获得。