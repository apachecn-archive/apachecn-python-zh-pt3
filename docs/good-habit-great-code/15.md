# 15.一堂设计课

索科尔斯基先生从他的桌子上站起来，走到教室前面的电脑控制台前。这是他在史摩维尔高中教高级计算机科学课的第四天。他接替了休病假的帕姆·琼斯。索科尔斯基面对的是一大堆毫无笑容的面孔。

“我假设每个人都已经完成了第一项任务。稍后我会过来检查你的每一个程序。但是我想让一个学生为全班演示他或她的程序。我可以有一个志愿者吗？”

没有人举手。索科尔斯基先生拿起他的年级记录本，浏览学生名册。

"罗杰，在 1 到 26 之间选一个数字."

“好的，七个，”学生回答道。

“七，那是，让我们看看，那是安娜。安娜，请你上来演示一下你的程序好吗？”

安娜是个聪明的大三学生。她在琼斯小姐的指导下做得很好，她对教学的热情和对编程的热爱得到了她所有学生的赞赏。索科尔斯基先生与众不同。他以前从未当过高中老师，这一点在他的第一项任务中表现得很明显。

安娜拿着她的笔记本电脑来到控制台前。她接上了视频电缆，输入了她的程序名:`mult`。屏幕上出现了一个问号。她输入了 2。又出现了一个问号。她输入了 3。答案 6 出现了，后面又是一个问号。安娜一言不发地走回她的座位。从她生硬的态度来看，她显然认为这项任务是浪费时间。

“对不起安娜，但我不能给你这个节目任何荣誉。就是缺。”

安娜看上去既困惑又恼火。“但这正是你要求的。将两个数相乘的程序。”

“好吧，让我想想，”索科尔斯基先生说。他拿出一份作业，读了起来。写一个程序，接受两个数字作为输入，并打印它们的乘积。假设这个任务是一个更大的商业项目的一部分，也就是说，它需要一个用户友好的界面，并且必须包含重要的功能。当然，你的程序必须重构。总是努力付出比预期更多的东西。”

“我做到了，”安娜说。“你还想要什么？”

“好吧，一个用户应该知道他正在运行什么程序。你需要一个标题和一些用户说明。你的问号是什么意思？对用户要明确。你的程序似乎会永远运行下去。用户应该如何退出程序？从笔记本电脑上取下电池？所以让我问你一个问题。在程序打印出答案后，你认为用户应该看到一条信息说“输入 X 退出”，还是“输入 C 继续添加”？这是个好主意吗？”

“嗯，是的，我想是的。但就是这么简单的程序，谁在乎呢？”安娜说。

“给你打分的人会在乎，不管那有多重要。但无论如何，我的建议实际上是一个可怜的建议。我们不希望用户输入不必要的信息。当请求第一个数字时，用户指令可能是，“输入一个数字或“X”退出。”因此，用户只需输入另一个数字即可继续，而不是先输入“C”再输入一个数字。"

安娜看上去有些恼怒，但什么也没说。

“好吧，也许我没有把任务讲得足够清楚。所以我有个主意。在这期间做这个，我们将在 30 分钟后回到教室再次讨论这个项目。而且一定要付出比预期更多。如果你提前完成了，那就开始第二项任务。”

三十分钟后，安娜再次展示了她修改过的程序。

“你给我的比我要求的多吗，安娜？”

“我给了你想要的，”安娜说。

“嗯，也许这就够了。安娜，我可以建议你输入的两个数字吗？”

“当然可以。”

"好，我希望第一个数字是 1 . "

安娜走进了 1 号。

"第二个数字是三分之一，也就是 1 后面跟一个斜杠，后面跟一个 3 . "

“这样的数字是行不通的，索科尔斯基先生。我已经试过了。你必须像这样输入它们。”

安娜输入了`0.333333333`。她的程序打印了`0.333333333`。

“好吧，但是假设我不希望输出中有那么多小数位。为什么不给我一个选择，安娜？”

"你说用户不应该被问题纠缠，所以我听从了你的建议."

“实际上，我说过不应该要求用户输入任何不必要的信息。所以为什么不把缺省的小数位数设为两位呢，除非输出是整数。并允许用户输入一个数字，输入“X”退出，或者输入“P”将默认精度从 2 更改为 1。这样用户就可以忽略这些选项。”

阶级反应是各种形式的烦恼。

“好吧，那就把这个程序搞定，我周一再看看大家的作品。祝你周末愉快，经常想起我。”

索科尔斯基的讽刺并没有被接受，但他在第一天就与一名学生发生了冲突，其他学生对他的愤怒感到厌倦。

周一，安娜再次用索科尔斯基之前用过的数字演示了她的程序。

“到目前为止还不错，安娜。但是你给我的比我要求的多吗？”

“你告诉我，索科尔斯基先生。”

“好，输入 2 作为你的第一个数字，然后输入字符串‘happy’我想知道两倍的快乐是什么？是的，我想知道那是什么数字。"

安娜输入了 2，后面是“快乐”

程序回答“不是一个数字。请重新输入一个数字。

“啊，非常好的安娜。你预料到了我的无理而扭曲的要求。但是如果我只按回车键，什么都不输入呢？”

“这也是行得通的。我测试过了，”安娜说。

“好吧，那这个程序就改进得多了。但是一个改进是不仅仅打印一个数字的输出，而是打印第一个输入，后面跟着一个乘号，第二个输入，后面跟着一个等号，最后是乘积。这更好，因为它允许用户检查输入错误。所以现在需要这样做。”

他转向全班。

“你们上周写的这个程序的第一个版本可能是一个很好的初稿。我是认真的。当程序不能正确地乘以 2 乘以 3 时，你可以花费大量的时间为特殊情况编码，没有浪费。所以首先要有一个工作的基本版本，并保持它的工作状态。然后为特殊情况编写代码，就像我刚才给安娜的两个例子。有时您需要首先编写测试，有时自动化测试。但那是另一个教训。”

“有四种电脑错误。大多数学生只知道一个。大多数学生认为，如果他们的程序在所有合理的情况下每次都做了它应该做的事情，那么程序就完成了。但这是不真实的。像这样的程序只消除了第一类错误:编译错误和逻辑错误。第二种错误是代码可读性错误或样式错误。关于某人的代码，你能说的最糟糕的事情是，为了调试它，或者修改它，你必须从头开始重写它。第三种错误是功能性错误。程序是否拥有用户想要的所有特性？第四种错误是接口错误。这个程序使用起来直观吗？程序是否在正确的时间给用户他或她需要的信息？由于我们大部分的学校作业都是实现算法，所以很少遇到功能和接口错误。”

“那么，我来问你。你能考虑给我们的“mult”程序更多的功能吗？为什么一个学生会启动我们的程序而不是去拿计算器？我们的程序在将两个数字相乘时可能会做些什么，而这是计算器不容易做到的？”

全班鸦雀无声。

"好吧，我们就坐在这里，直到有人想到办法为止。"

过了一会儿，一个学生举起了手。“我们可以让用户输入一个带逗号的大数字，因为如果它是一个巨大的数字，这使得数字更可读。”

“好吧，我们可以这样做，这样会使程序更好。这是一个很好的建议，但是为了我们的目的，我将忽略逗号。这将是一个小功能的大量工作。我认为我们的时间可以更好地利用。那么，我们还能让我们的程序做些什么呢，把它限制在两个数相乘？”

另一个学生举起了手。“你可以放入‘1/3’。我的意思是我们可以为此编码。”

“这是一个非常好的特性，但是这看起来是不是需要大量的工作？我的意思是你必须扫描输入的斜线，然后试着读出两边的数字。不过，我还是喜欢你的想法。我们还能给这个项目增加什么？

全班又一次安静下来。

"所以，我想，我们明天再考虑这个问题."

安娜举起了手。"我想我们可以允许用户改变两个输入数字的基数."

“是的，一点不错。每个输入数字都有自己的基数。当然，在内部，我们以十为基数工作。我们只需要把 b 进制的输入转换成十进制。我们如何做到这一点？嗯，int casting 的过程非常简单。下面是 6 进制 23 的代码，10 进制 15:`int('23',6)`。这有点尴尬，但只有在不使用 base 10 时才需要它。

但是‘1/3’的输入不会直接翻译成数字。那么有没有人知道如何在不扫描的情况下做到这一点，这将是太多的工作？"

全班又一次安静下来。

“我将建议一个你们大多数人不知道的技巧:精彩的 Python `eval`指令，它是一个表达式解析器。在网上查一下，但是这里有一个例子，把 6 进制的 23 乘以‘1/3’:

```
input(x)       # x = "int('23',6)*1/3"
print(eval(x)) # Output: 5.0

```

“事实上，用`eval`你可以计算任何算术表达式。所以，在角落里拿起我的《如何计算算术表达式》讲义，然后到你们的电脑上。”

当安娜坐下后，她去网上找了一些关于`eval`命令的例子。这个问题开始引起她的兴趣。她没有想到任何人需要将不同基数的数字相乘是不切实际的。总是坐在安娜旁边的伊丽莎白靠了过来。"安娜，你能理解这项任务吗？"

“是的，我想我马上会的。”

“好吧。我想我会等你完成，然后得到你的帮助。”

伊丽莎白的帮助想法是复制一些安娜的代码。安娜注意到索科尔斯基先生似乎从来没有注意到任何抄袭。他偶尔警告班上的同学要当心从同学那里获得太多的帮助，但鼓励学生用代码想法互相帮助。安娜一度想知道为什么伊丽莎白不能自己写很多代码。只是看起来没那么难。安娜停下来，环顾四周。爱丽丝也在阅读关于`eval`函数的内容。数学天才尤里已经开始编程了。她听到阿维告诉大卫，“你写精确部分，我写计算部分。”其他学生在网上聊天或玩耍。他们中有太多的人在侍候他们的同学。安娜突然想到这门课只对几个学生开放。其他人只是记忆和复制代码的关键部分，并且似乎满足于这样做。这只是世界上又一件对安娜来说没有意义的怪事。

安娜继续看书。

伊丽莎白在安娜的键盘旁边放了一块新口香糖。

结局

我偶然看到一本有趣的 C.S .的书，名为《测试计算机软件》,第二版。Kaner、Falk 和 Nguyen(Wiley，1999 年)。这本书有一个附录，列举了 340 多个常见的软件错误。大多数错误都与界面和功能有关，这是工业界比计算机科学班的学生更关心的问题。在第一页，作者有一个惊人的例子，引起了我的兴趣。他们要求读者考虑编写一个不超过两个数相加的程序。然后他们用这个简单的例子来说明在设计和测试中什么是行业认为合适的。

首先，他们考虑了接口。用户知道程序应该做什么吗？用户知道他们在程序中的位置吗？有屏幕说明吗？他们清楚了吗？有没有对安全的执念？用户如何停止程序？输入是否与最终答案一起显示？它们是否排成一行或以视觉上吸引人的方式展示？

接下来是关于功能的问题。输入不正确会发生什么？它中止了整个程序还是用户有机会改正它？数字前后可以有空格吗？两个输入基数可以换吗？精度可以改变吗？

因为我作为老师和学生的学校作业很少包括关于接口和功能的问题，所以我决定写这个程序，把加法改为乘法。

我的第一步是编写代码将基数 b 改为基数 10。我写的代码允许用户输入一个“`B`”或“`b`”，而不是一个数字，如果他想改变一个基数。但是这使得界面不方便。我放弃了这段代码，编写了新的代码，允许用户输入一个数字或者一个以数字为基数的元组——比如`(12,8)`。但是这对用户来说太多了(括号和逗号)。我再次放弃了我的代码，编写了新的代码，允许用户输入一个数字、两个数字(一个带基数的数字)或三个数字(一个带基数的数字，后跟所需的小数精度)。这需要我用空格或逗号来分隔数字。如果输入了多余的空格，我就必须把它们去掉。

所有这些重新设计和编码工作持续了几天。花费最多时间的是考虑如何检测无效的用户输入。编码变得既令人沮丧又耗时。我敢给学生布置如此折磨人的作业吗？我学到的唯一一课是，与学术项目相比，消费者项目有多难。事实上，两天过去了，没有任何编码。

最终，我有了一个新想法，允许在同一行上输入两个输入数字，仅用星号将它们分开。然后突然想到了 Python `eval`函数。这个函数与一个`try/except`块和一个整型转换成一个基数相结合将会使所有这些讨厌的问题消失。我写了一些测试代码，发现`sqrt`、`log`等 Python 内置函数被`eval`完美评估。甚至多余的空格都被`eval`忽略了。我的实际程序突然变得容易编写了。

所有这些花了五天的时间思考和编码。为什么我没有马上想到用`eval`？答案是，在我去寻找新的想法之前，我必须对我的代码感到不满意。只有某种失败促使我寻找新的设计。我想这可能是我改进代码设计的唯一方法。在这五天里，我个人学到了很多东西。不幸的是，学生们每门课的时间有限，不允许像这样的作业被分配到课堂上。只有少数学生能够取得进步，而大多数学生可能都是靠自己取得这样的进步的。能给学生的，就是想象中的索科尔斯基先生给的那种作业。在几乎所有的最初几堂计算机科学课中，基本思想需要尽早给出，学生们只是通过将各部分放在一起或通过查找关键主题来建立编码技能。在一些简单的版本被证明不合适之后，索科尔斯基先生更进一步，允许这项任务不断发展。下面是我最后的节目。也许你能明白为什么这个程序花了我五天时间。

```
"""+==========+========-========*========-========+===========+
   ||                 The Multiplying Program                ||
   ||              by M. Stueben (October 8, 2017)           ||
   ||                                                        ||
   || Description:See printDirections().                     ||
   || Language:   Python Ver. 3.4\.                           ||
   || Graphics:   None                                       ||
   || References:  Cem Kaner, Jack Falk, Hung Quoc Nguyen, Testing||
   ||              Computer Software, 2nd Ed. (John Wiley, 1999), ||
   ||             pages 1-7\.                                 ||
   +==========+========-========*========-========+===========+
"""

#####################<START OF PROGRAM>########################

def printDirections():
   print('+-------------------------------------------------+')
   print('|        == THE MULTIPLICATION PROGRAM ==         |')
   print('|      by M. Stueben (Ver. 1.0, August 2017)      |')
   print('|DIRECTIONS:                                      |')
   print('|1\. Enter a first number, followed by an asterisk (*),|')
   print('|   followed by a second number. Examples:        |')
   print('|    5280 * 3.14, (-27 + 6) * (1/3), sqrt(100) * log(10).  |')
   print('|2\.  Push enter to see the output.                 |')
   print('|OPTIONS:                                        |')
   print('|3\. Enter X to exit the program.                 |')
   print('|4\. Enter P to change the precision (default = 2) of any                                       |')
   print('|   float output.                                |')
   print("|5\. To enter, say 21 in base 19, type int('21',19).                                |")
   print('|   Special case: 0X12 and 0x12 both are 18 in base 10\.                                     |')
   print('|6\. The user will be requested to re-enter any bad input.                                       |')
   print('+------------------------------------------------+')
   print('\n RESULTS:')
#------------------------------------The multiplying program--

def requestPrecisionFromUser():

    msg ='Choose the decimal precision of your answer (from 0 to 17):'
    while True:
        data = input (msg)
        ch = data.strip()
        if ch in {'X', 'x'}:
           print (' Goodbye.')
           return
        try:
           precision = int(data)
           if (precision < 0)or(precision> 17)or(type(precision) != int):
              raise Error
        except:
           msg = 'Bad input. Choose a non-negative integer (0 to 17).'
           continue
        return precision
#------------------------------------The multiplying program--

def requestAndMultiplyTwoNumbers():
#---Initialize.
    from math import sqrt, log, log10
    precision      = 2
    problemCounter = 0
    errorMsg       = ''

    while True: 

        msg = errorMsg \
              + 'Enter expression * expression, P (precision), or X (exit).'
        data = input(msg) # Dialog box

#-------Check for 'X or x'.
        ch = data.strip()
        if ch in {'X', 'x'}:
            print (' Goodbye.')
            return

#-------Check for 'P or p.
        if ch in {'P', 'p'}:
            precision = requestPrecisionFromUser()
            errorMsg = ''
            continue

#-------Attempt to calculate an answer.
        try:
            answer = eval(data)
            if not isinstance(answer,(int, float)): raise exception
            errorMsg = ''
        except:
            errorMsg = '============ BAD INPUT ===========\n'\
                     + 'You entered -->   ' + data +'.\n'
            continue

#-------Print the answer.
#       Sample output: "1\. 1.23 * 4.56 = 5.61 [decimal precision = 2.]"
        problemCounter += 1
        if type(answer) == float:
           print('    ', str(problemCounter) + '. ', data, ' = ', \
                 round(answer, precision), \
                 ' [decimal precision = ', precision, '.]', sep ='')
        else:
           print('   ', str(problemCounter) + '.', data, '=', answer)
#==========================<MAIN>===========================

def main():

    printDirections()
    requestAndMultiplyTwoNumbers()
#============<GLOBAL CONSTANTS and GLOBAL IMPORTS>============
if __name__ == '__main__':
     from time import clock; START_TIME = clock(); main(); print('- '*12);
     print('RUN TIME:%6.2f'%(clock()-START_TIME), 'seconds.');
#######################<END OF PROGRAM>#######################

```

问题:为什么允许甚至向学生介绍`eval`功能？网上到处都是远离这个 Python 函数的警告。为了测试`eval`有多危险，我在我的 Windows `E`目录下创建了一个名为`filex.py`的虚假文件。然后，我通过在 Python 中运行这一行来销毁文件。

```
eval("__import__('os').remove('e:filex.py')")

```

我想这一行对于让一个试用程序自行删除可能是有用的。

只有当`eval`函数接受来自不可信来源的用户输入时，它才是危险的。由于学生通常是唯一能接触到他或她自己的代码的人，这种担心对于学校的问题是没有根据的。`eval`函数可以在程序中创造奇迹，就像这里一样。向学生介绍`eval`是一个讨论`eval`可以对恶意代码做什么的机会，更有趣的是，是什么促使人们变得恶意。

对`eval`函数的讨论，以及对某些编程风格的绝对坚持，很容易变成情感的争论，而不是逻辑的争论。

下面的大纲是我信奉的一种设计方法论，但就像他们在 Zen 里说的，必须经历才能欣赏。

## 如何着手一个重大的计算机科学项目

1.  留出比你认为你需要的更多的时间。你可以花很多时间在一个程序上，但除了一些关于如何不写程序的见解之外，你没有什么可以展示的。
2.  计划专注。这意味着远离那个诱人但健谈的同学。如果你有一个伙伴，那么考虑结对编程。
3.  理解问题(=分析+程序规范)。这可能意味着构建一些例子。你也在寻找关系和洞察力。
4.  选择你的数据类型，然后设计/重新设计你的程序。
    1.  制作一个最小的设计。首先编写必须具备的功能，因此，这是一个早期的工作程序。后来，该有的功能都加了进去。最后，如果可能的话，编写函数。[在一个聪明的井字游戏程序中，第一个版本将是一个程序，其中计算机合法地玩，但随机地移动。]
    2.  预计最初的设计可能很差，您的数据类型可能需要更改。 
5.  写代码。
    1.  使用逐步细化和自我文档化的代码(很少注释)。
    2.  使用断言和错误陷阱。
    3.  写完之后测试每个关键函数(白盒测试)。
    4.  在编写复杂的算法之前，考虑编写一个粗糙的测试函数。
    5.  考虑在编写一个复杂的算法之后，用数百个随机输入来测试它。 
6.  根据新的见解、编码困难、用户反馈以及可能变化的规范，根据需要经常返回步骤 4 重新设计程序并改变数据类型。再次强调，接受最初的版本经常被证明是失败的，这确保了在第二个或更高版本中的成功。
7.  通过测试整个程序(黑盒测试)来修复最终的错误。你可能忽略了一些特殊情况或边缘情况。
8.  重构整个程序。这是你学习程序设计的地方。
9.  反思你的错误和吸取的教训。